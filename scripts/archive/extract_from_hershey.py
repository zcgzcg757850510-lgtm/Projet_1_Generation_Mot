#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä»Hersheyå­—ä½“æå–ç¬”ç”»æ•°æ®
Hersheyå­—ä½“æ˜¯å•çº¿å­—ä½“ï¼Œæ­£å¥½ç¬¦åˆæˆ‘ä»¬çš„ç¬”ç”»è·¯å¾„éœ€æ±‚
"""

import json
import os
import urllib.request


# Hersheyå­—ä½“çš„ç®€åŒ–ç‰ˆæœ¬ - æ‰‹åŠ¨å®šä¹‰æ ¸å¿ƒå­—ç¬¦
# åŸºäºHershey Roman Simplexå­—ä½“
# åæ ‡èŒƒå›´: é€šå¸¸ -16åˆ°+16 (X), -11åˆ°+11 (Y)

HERSHEY_STROKES = {
    # æ•°å­— 0-9
    '0': [
        [[-8, -9], [-8, -7], [-8, -5], [-8, -3], [-8, -1], [-8, 1], [-8, 3], [-8, 5], [-8, 7], [-8, 9],
         [8, 9], [8, 7], [8, 5], [8, 3], [8, 1], [8, -1], [8, -3], [8, -5], [8, -7], [8, -9], [-8, -9]]
    ],
    '1': [
        [[0, -9], [0, -7], [0, -5], [0, -3], [0, -1], [0, 1], [0, 3], [0, 5], [0, 7], [0, 9]]
    ],
    '2': [
        [[-7, -9], [-4, -9], [0, -9], [4, -9], [7, -9], [7, -5], [7, -1],
         [4, 3], [0, 6], [-4, 8], [-7, 9], [-4, 9], [0, 9], [4, 9], [7, 9]]
    ],
    '3': [
        [[-7, -9], [-4, -9], [0, -9], [4, -9], [7, -9], [7, -5], [7, -1], [4, 0], [0, 0]],
        [[0, 0], [4, 0], [7, 1], [7, 5], [7, 9], [4, 9], [0, 9], [-4, 9], [-7, 9]]
    ],
    '4': [
        [[7, 9], [7, 5], [7, 1], [7, -3], [7, -7], [7, -9], [0, -9], [-7, -9]],
        [[7, 0], [4, 0], [0, 0], [-4, 0], [-7, 0]]
    ],
    '5': [
        [[7, -9], [4, -9], [0, -9], [-4, -9], [-7, -9], [-7, -5], [-7, -1]],
        [[-7, -1], [-4, -1], [0, -1], [4, -1], [7, -1], [7, 3], [7, 7], [7, 9], [4, 9], [0, 9], [-4, 9], [-7, 9]]
    ],
    '6': [
        [[7, -9], [4, -9], [0, -9], [-4, -9], [-7, -9], [-7, -5], [-7, -1], [-7, 3], [-7, 7], [-7, 9],
         [-4, 9], [0, 9], [4, 9], [7, 9], [7, 5], [7, 1], [7, 0], [4, 0], [0, 0], [-4, 0], [-7, 0]]
    ],
    '7': [
        [[-7, -9], [-4, -9], [0, -9], [4, -9], [7, -9], [7, -5], [4, 0], [0, 4], [-4, 8], [-7, 9]]
    ],
    '8': [
        [[-7, -9], [-4, -9], [0, -9], [4, -9], [7, -9], [7, -5], [7, -1], [4, 0], [0, 0], [-4, 0], [-7, 0],
         [-7, 4], [-7, 8], [-7, 9], [-4, 9], [0, 9], [4, 9], [7, 9], [7, 5], [7, 1], [7, 0]]
    ],
    '9': [
        [[7, 9], [4, 9], [0, 9], [-4, 9], [-7, 9], [-7, 5], [-7, 1], [-7, -3], [-7, -7], [-7, -9],
         [-4, -9], [0, -9], [4, -9], [7, -9], [7, -5], [7, -1], [7, 0], [4, 0], [0, 0], [-4, 0], [-7, 0]]
    ],
    
    # å¤§å†™å­—æ¯ A-Z (ç®€åŒ–ç‰ˆæœ¬)
    'A': [
        [[-9, 9], [-6, 3], [-3, -3], [0, -9], [3, -3], [6, 3], [9, 9]],  # ä¸»ä½“
        [[-4, 3], [4, 3]]  # æ¨ªçº¿
    ],
    'B': [
        [[-8, -9], [-8, -6], [-8, -3], [-8, 0], [-8, 3], [-8, 6], [-8, 9]],  # ç«–çº¿
        [[-8, -9], [-4, -9], [0, -9], [4, -8], [6, -6], [6, -3], [4, -1], [0, 0], [-4, 0], [-8, 0]],  # ä¸ŠåŠ
        [[-8, 0], [-4, 0], [0, 0], [4, 1], [6, 3], [6, 6], [6, 8], [4, 9], [0, 9], [-4, 9], [-8, 9]]  # ä¸‹åŠ
    ],
    'C': [
        [[8, -7], [6, -9], [3, -9], [0, -9], [-3, -9], [-6, -7], [-8, -4], [-8, 0], [-8, 4],
         [-6, 7], [-3, 9], [0, 9], [3, 9], [6, 9], [8, 7]]
    ],
    'D': [
        [[-8, -9], [-8, -6], [-8, -3], [-8, 0], [-8, 3], [-8, 6], [-8, 9]],  # ç«–çº¿
        [[-8, -9], [-4, -9], [0, -9], [3, -9], [6, -7], [8, -4], [8, 0], [8, 4], [6, 7], [3, 9], [0, 9], [-4, 9], [-8, 9]]
    ],
    'E': [
        [[-7, -9], [-7, -6], [-7, -3], [-7, 0], [-7, 3], [-7, 6], [-7, 9]],  # ç«–çº¿
        [[-7, -9], [-4, -9], [0, -9], [4, -9], [7, -9]],  # ä¸Šæ¨ªçº¿
        [[-7, 0], [-4, 0], [0, 0], [4, 0]],  # ä¸­æ¨ªçº¿
        [[-7, 9], [-4, 9], [0, 9], [4, 9], [7, 9]]  # ä¸‹æ¨ªçº¿
    ],
    'F': [
        [[-7, -9], [-7, -6], [-7, -3], [-7, 0], [-7, 3], [-7, 6], [-7, 9]],  # ç«–çº¿
        [[-7, -9], [-4, -9], [0, -9], [4, -9], [7, -9]],  # ä¸Šæ¨ªçº¿
        [[-7, 0], [-4, 0], [0, 0], [4, 0]]  # ä¸­æ¨ªçº¿
    ],
    'I': [
        [[0, -9], [0, -6], [0, -3], [0, 0], [0, 3], [0, 6], [0, 9]]
    ],
    'L': [
        [[-7, -9], [-7, -6], [-7, -3], [-7, 0], [-7, 3], [-7, 6], [-7, 9]],  # ç«–çº¿
        [[-7, 9], [-4, 9], [0, 9], [4, 9], [7, 9]]  # ä¸‹æ¨ªçº¿
    ],
    'O': [
        [[-8, -9], [-6, -9], [-3, -9], [0, -9], [3, -9], [6, -9], [8, -7], [8, -4], [8, 0], [8, 4],
         [8, 7], [6, 9], [3, 9], [0, 9], [-3, 9], [-6, 9], [-8, 7], [-8, 4], [-8, 0], [-8, -4], [-8, -7], [-8, -9]]
    ],
    'T': [
        [[-9, -9], [-6, -9], [-3, -9], [0, -9], [3, -9], [6, -9], [9, -9]],  # ä¸Šæ¨ªçº¿
        [[0, -9], [0, -6], [0, -3], [0, 0], [0, 3], [0, 6], [0, 9]]  # ç«–çº¿
    ],
    
    # å°å†™å­—æ¯ a-z (ç®€åŒ–ç‰ˆæœ¬ - åªåˆ—å‡ ä¸ªå…³é”®çš„)
    'a': [
        [[6, -6], [3, -6], [0, -6], [-3, -5], [-5, -3], [-5, 0], [-5, 3], [-3, 5], [0, 6], [3, 6], [6, 6]],
        [[6, -6], [6, -3], [6, 0], [6, 3], [6, 6]]
    ],
    'b': [
        [[-6, -9], [-6, -6], [-6, -3], [-6, 0], [-6, 3], [-6, 6], [-6, 9]],
        [[-6, -2], [-3, -4], [0, -6], [3, -6], [6, -5], [6, -2], [6, 1], [6, 4], [3, 6], [0, 6], [-3, 5], [-6, 3]]
    ],
    'i': [
        [[0, -9], [0, -8]],  # ç‚¹
        [[0, -6], [0, -3], [0, 0], [0, 3], [0, 6]]  # ç«–çº¿
    ],
    'o': [
        [[-6, -3], [-6, 0], [-6, 3], [-3, 6], [0, 6], [3, 6], [6, 3], [6, 0], [6, -3], [3, -6], [0, -6], [-3, -6], [-6, -3]]
    ],
}


def convert_hershey_to_mmh(strokes):
    """
    å°†Hersheyåæ ‡è½¬æ¢ä¸ºMMHåæ ‡ç³»ç»Ÿ
    
    Hershey: X: -16åˆ°+16, Y: -11åˆ°+11 (åŸç‚¹åœ¨ä¸­å¿ƒï¼ŒYå‘ä¸Š)
    MMH: X: 0-1024 (ä¸­å¿ƒ512), Y: -124åˆ°900 (åŸç‚¹åœ¨å·¦ä¸Šï¼ŒYå‘ä¸‹)
    """
    mmh_strokes = []
    
    for stroke in strokes:
        mmh_stroke = []
        for x, y in stroke:
            # ç¼©æ”¾å’Œå¹³ç§»
            # X: -16~16 -> 312~712 (å±…ä¸­åœ¨512ï¼Œå®½åº¦400)
            mmh_x = int(512 + x * 12.5)  # 400/32 = 12.5
            
            # Y: -11~11 -> é«˜åº¦çº¦450 (å±…ä¸­åœ¨388)
            # æ³¨æ„Yè½´ç¿»è½¬
            mmh_y = int(388 - y * 20)  # çº¦450/22 = 20
            
            mmh_stroke.append([mmh_x, mmh_y])
        
        mmh_strokes.append(mmh_stroke)
    
    return mmh_strokes


def create_full_alphabet():
    """åˆ›å»ºå®Œæ•´çš„å­—æ¯è¡¨ - å¯¹äºç¼ºå¤±çš„å­—æ¯ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬"""
    
    # åŸºæœ¬å­—æ¯ï¼ˆéœ€è¦è¡¥å……æ›´å¤šï¼‰
    alphabet = {}
    
    # æ·»åŠ å·²å®šä¹‰çš„å­—ç¬¦
    for char, strokes in HERSHEY_STROKES.items():
        mmh_strokes = convert_hershey_to_mmh(strokes)
        
        if char.isdigit():
            char_type = 'digit'
        elif char.isupper():
            char_type = 'uppercase'
        else:
            char_type = 'lowercase'
        
        alphabet[char] = {
            "character": char,
            "medians": mmh_strokes,
            "strokes": len(mmh_strokes),
            "type": char_type,
            "source": "hershey_roman_simplex",
            "license": "Public Domain",
            "coordinate_system": "MMH"
        }
    
    return alphabet


def generate_missing_letters():
    """ä¸ºç¼ºå¤±çš„å­—æ¯ç”Ÿæˆç®€å•çš„å ä½ç¬¦ï¼ˆåç»­å¯ä»¥å®Œå–„ï¼‰"""
    
    # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šå­—æ¯çš„å®šä¹‰
    # æˆ–è€…åˆ›å»ºç®€å•çš„å ä½ç¬¦
    
    missing_uppercase = [c for c in 'GHJKMNPQRSUVWXYZ' if c not in HERSHEY_STROKES]
    missing_lowercase = [c for c in 'abcdefghijklmnopqrstuvwxyz' if c not in HERSHEY_STROKES]
    
    print(f"\nâš ï¸ éœ€è¦è¡¥å……çš„å­—æ¯:")
    print(f"  å¤§å†™: {', '.join(missing_uppercase)}")
    print(f"  å°å†™: {', '.join(missing_lowercase)}")
    print(f"\nğŸ’¡ è¿™äº›å­—æ¯å°†ä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬ï¼ˆå¯ä»¥åç»­å®Œå–„ï¼‰")
    
    return missing_uppercase, missing_lowercase


def main():
    print("=" * 70)
    print("ä»Hersheyå­—ä½“æå–ç¬”ç”»æ•°æ®")
    print("=" * 70)
    print("\nâœ¨ Hersheyå­—ä½“æ˜¯å•çº¿å­—ä½“ï¼Œå®Œç¾ç¬¦åˆç¬”ç”»è·¯å¾„éœ€æ±‚ï¼")
    print("ğŸ“œ è®¸å¯è¯: Public Domain (å…¬å…±é¢†åŸŸ)")
    print()
    
    # ç”Ÿæˆå­—æ¯è¡¨
    alphabet = create_full_alphabet()
    
    print(f"\nâœ… å·²å®šä¹‰ {len(alphabet)} ä¸ªå­—ç¬¦:")
    print(f"  æ•°å­—: {sum(1 for c in alphabet if alphabet[c]['type'] == 'digit')}")
    print(f"  å¤§å†™: {sum(1 for c in alphabet if alphabet[c]['type'] == 'uppercase')}")
    print(f"  å°å†™: {sum(1 for c in alphabet if alphabet[c]['type'] == 'lowercase')}")
    
    # æ£€æŸ¥ç¼ºå¤±çš„å­—æ¯
    missing_upper, missing_lower = generate_missing_letters()
    
    # ä¿å­˜å·²æœ‰çš„
    output_file = 'data/alphanumeric_medians_hershey.json'
    
    # å¤‡ä»½æ—§æ–‡ä»¶
    old_file = 'data/alphanumeric_medians.json'
    if os.path.exists(old_file):
        backup_file = old_file + '.before_hershey'
        import shutil
        shutil.copy(old_file, backup_file)
        print(f"\nğŸ’¾ å·²å¤‡ä»½æ—§æ–‡ä»¶åˆ°: {backup_file}")
    
    # ä¿å­˜æ–°æ–‡ä»¶
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(alphabet, f, ensure_ascii=False, indent=2)
    
    file_size = os.path.getsize(output_file)
    print(f"\nğŸ’¾ å·²ä¿å­˜åˆ°: {output_file}")
    print(f"ğŸ“¦ æ–‡ä»¶å¤§å°: {file_size / 1024:.2f} KB")
    
    # æ˜¾ç¤ºç¤ºä¾‹
    print("\nğŸ“ ç¤ºä¾‹æ•°æ® - å­—æ¯A:")
    print(f"  ç¬”ç”»æ•°: {alphabet['A']['strokes']}")
    for i, stroke in enumerate(alphabet['A']['medians'], 1):
        print(f"  ç¬”ç”»{i}: {len(stroke)}ä¸ªç‚¹")
        print(f"    èµ·ç‚¹: {stroke[0]}")
        print(f"    ç»ˆç‚¹: {stroke[-1]}")
    
    print("\n" + "=" * 70)
    print("âœ… æå–å®Œæˆï¼")
    print("\nâš ï¸ æ³¨æ„:")
    print(f"  1. å½“å‰å·²å®šä¹‰ {len(alphabet)} ä¸ªå­—ç¬¦")
    print(f"  2. è¿˜éœ€è¡¥å…… {len(missing_upper) + len(missing_lower)} ä¸ªå­—æ¯")
    print(f"  3. å¯ä»¥å…ˆç”¨ç°æœ‰å­—ç¬¦æµ‹è¯•ç³»ç»Ÿ")
    print("\nğŸ“ ä¸‹ä¸€æ­¥:")
    print("  1. æµ‹è¯•å½“å‰å­—ç¬¦: python start_server.py")
    print("  2. è¡¥å……ç¼ºå¤±å­—æ¯ï¼ˆå¦‚æœéœ€è¦ï¼‰")
    print("  3. éªŒè¯æ¸²æŸ“æ•ˆæœ")
    print("=" * 70)
    
    return 0


if __name__ == "__main__":
    import sys
    sys.exit(main())

