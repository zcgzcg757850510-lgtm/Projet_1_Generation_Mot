# 技术架构文档

## 系统架构概览

Generateur_Mot 是一个多层次的中文手写字体生成系统，采用模块化设计，支持从原始汉字数据到最终SVG渲染的完整处理流程。

## 核心模块架构

### 1. 数据层 (Data Layer)
```
data/
├── make-me-a-hanzi/           # MMH原始数据
├── hanzi_data_full.json       # 合并后的汉字数据
├── style_profiles.json        # 风格配置文件
└── stroke_types.json          # 笔画类型映射
```

**职责**：
- 存储汉字笔画的几何数据
- 定义风格参数和笔画分类规则
- 提供配置化的参数管理

### 2. 核心处理层 (Core Processing Layer)
```
src/
├── parser.py                  # 数据解析器
├── classifier.py              # 笔画分类器
├── centerline.py              # 中轴线处理器
├── styler.py                  # 风格应用器
├── renderer.py                # SVG渲染器
├── main.py                    # 命令行入口
└── transforms/                # 模块化变换系统
    ├── __init__.py            # 变换模块包
    ├── base_transform.py      # 变换基类接口
    ├── move_transform.py      # 移动变换模块
    ├── tilt_transform.py      # 倾斜变换模块
    ├── scale_transform.py     # 缩放变换模块
    ├── smooth_transform.py    # 平滑变换模块
    └── transform_manager.py   # 变换管理器
```

### 3. Web服务层 (Web Service Layer)
```
web/
├── app.py                     # Flask应用主文件
├── ui.html                    # Web界面主模板（模块化重构后）
├── css/                       # CSS模块化文件目录
│   ├── base.css              # 基础样式和CSS变量
│   ├── components.css        # UI组件样式
│   ├── toast.css             # 提示消息样式
│   ├── modal.css             # 弹窗样式
│   ├── preview-cards.css     # 预览卡片样式
│   └── dropdown.css          # 下拉菜单样式
├── html/                      # HTML模板文件目录
│   └── modals/               # 弹窗模板文件
│       ├── preset-modal.html # 预设管理弹窗
│       ├── article-modal.html# 文章生成弹窗
│       └── grid-modal.html   # 网格变形弹窗
├── js/                        # JavaScript模块化文件目录
│   ├── utils.js              # 工具函数库
│   ├── state-manager.js      # 状态管理系统
│   ├── preset-modal.js       # 预设管理模块
│   ├── modal-loader.js       # 模板动态加载器
│   ├── grid-transform.js     # 网格变形模块
│   ├── generation-service.js # 生成服务模块
│   └── preview-manager.js    # 预览管理模块
├── services/
│   ├── generation.py          # 字符SVG生成服务
│   ├── files.py               # 文件管理服务
│   ├── style.py               # 风格处理服务
│   └── grid_transform.py      # 网格变形处理服务
└── config.py                  # Web配置
```

#### 3.1 前端模块化架构 (Frontend Modular Architecture)
**设计目标**：实现CSS、HTML、JavaScript的分离和模块化管理，提升代码维护性和性能

**CSS模块化设计**：
- **分层架构**：基础样式 → 组件样式 → 功能样式 → 特效样式
- **CSS变量系统**：统一颜色、字体、间距等设计令牌
- **模块职责分离**：每个CSS文件负责特定功能域
- **响应式设计**：统一的断点和媒体查询管理

**HTML模板化系统**：
- **模态框模板分离**：将大型HTML块抽离为独立模板文件
- **动态加载机制**：通过Fetch API异步加载HTML模板
- **模板缓存策略**：避免重复加载，提升性能
- **错误处理机制**：完善的加载失败回退策略

**JavaScript深度模块化管理**：
- **状态管理系统** (`state-manager.js`)：全局状态管理和模块间通信协调
  - 全局状态容器：维护当前字符、活动标签、网格状态等
  - 事件总线：模块间事件订阅和发布机制
  - 状态持久化：localStorage自动保存和恢复
  - 调试支持：状态变更日志和统计信息
- **工具函数库** (`utils.js`)：通用工具函数集合
  - Cookie管理：get/set操作和过期处理
  - 状态保存：表单自动保存和恢复机制
  - 调试工具：网格状态测试和剪贴板操作
  - 防抖节流：性能优化工具函数
- **网格变形模块** (`grid-transform.js`)：SVG网格变形核心功能
  - 控制点管理：创建、拖拽、状态保存
  - SVG变形：实时路径变换和双线性插值
  - 网格绘制：Canvas网格层和交互控制
  - 状态持久化：变形参数localStorage保存
- **生成服务模块** (`generation-service.js`)：字符生成核心业务逻辑
  - D2生成：高级字符处理和参数传递
  - 文章生成：批量字符处理和布局合成
  - 结果显示：生成状态跟踪和错误处理
  - API封装：后端服务调用和响应处理
- **预览管理模块** (`preview-manager.js`)：图片预览和界面更新
  - 图片加载：A/B/C/D/D2预览图片管理
  - SVG检测：文件存在性检查和状态更新
  - 测试窗口：调试信息显示和内容管理
  - 缓存处理：图片缓存破坏和刷新机制
- **模板加载器** (`modal-loader.js`)：HTML模板动态加载
  - 异步加载：Fetch API模板获取
  - 缓存机制：避免重复加载提升性能
  - 错误处理：加载失败回退和用户提示
  - 状态跟踪：加载状态管理和重复操作防护

**性能优化策略**：
- **代码分割**：主页面体积减少约60%，JavaScript代码模块化拆分
- **并行加载**：CSS、HTML模板和JavaScript模块同时加载
- **缓存机制**：模板和状态数据缓存，避免重复请求和计算
- **懒加载**：模态框内容和复杂功能仅在需要时初始化
- **状态优化**：全局状态管理减少重复DOM操作和数据传递
- **事件优化**：统一事件总线减少事件监听器数量和内存占用

#### 3.2 SVG自动加载和网格变形架构
- **功能**：自动加载D0图片到网格画布，支持实时拖拽变形
- **核心组件**：
  - `autoLoadD0ToGrid()` - D0图片自动加载函数
  - `loadImageToGridCanvas()` - 图片加载到画布函数
  - `applyGridDeformation()` - 网格变形应用函数
  - `drawGrid()` - 网格绘制函数
  - `GridStateManager` - 网格状态管理器
  - 网格密度选择：支持2×2到5×5四种网格规格
- **工作流程**：
  1. 页面初始化时自动检测当前字符
  2. 从多个路径尝试加载D0 SVG文件
  3. 同时加载到Canvas背景和SVG容器
  4. 设置网格控制点和事件监听
  5. 拖拽控制点时实时变形SVG元素
- **技术特点**：
  - 双层显示：Canvas网格层 + SVG变形层
  - 路径自动发现：支持多种URL格式尝试
  - 实时变形：基于网格控制点的SVG路径变换
  - 状态持久化：网格状态和变形参数localStorage保存
  - 状态恢复：页面刷新后自动恢复控制点位置和变形状态
- **状态管理优化**：
  - 修复初始化时序问题：先创建控制点数组，再加载保存状态
  - 双重变形恢复：状态加载时和SVG加载完成时都检查并应用变形
  - 重置功能完善：使用原始backgroundImage位置恢复SVG到初始状态
- **D1集成（当前实现）**：
  - 前端 D1 按钮可携带 `grid_state` 调用 `/api/gen_single`（type=D1）
  - 后端对当前 C 的SVG应用网格变形，输出到 `D1_grid_transform/`（界面 D2 窗口）
  - 兼容旧流程 `/gen?type=D2` 基于最新 D1 输出 `_d2.svg` 到 `C_processed_centerline/`
  - 为保证平滑边缘，统一封装 `apply_grid_deformation_to_svg` 默认执行“矢量高精度变形 → 2048px 栅格化 → LANCZOS 下采样至 256px”，并以 `<image>` 形式嵌入SVG（可配置关闭以保持纯矢量）。

#### 3.2 文章SVG合成架构
- **功能**：基于D1字符SVG生成完整文章布局
- **流程**：字符生成 → SVG提取 → 布局合成 → 预览显示
- **特点**：支持自动换行、字间距调整、A4纸张布局
- **预览**：实时在Web界面显示，支持SVG格式下载

#### 2.1 数据解析器 (Parser)
- **功能**：解析MMH JSON数据，提取笔画路径
- **输入**：汉字Unicode，MMH数据文件
- **输出**：标准化的笔画点序列

#### 2.2 笔画分类器 (Classifier)
- **功能**：识别笔画类型（横、竖、撇、捺等）
- **算法**：基于几何特征的分类算法
- **输出**：带类型标签的笔画数据

#### 2.3 中轴线处理器 (Centerline)
- **功能**：多阶段笔画处理的核心模块
- **处理阶段**：
  1. 起笔方向调整
  2. 终笔方向调整
  3. 裁剪和端点保护
  4. 模块化变换系统（移动、倾斜、缩放、平滑）

#### 2.6 模块化变换系统 (Transform System)
- **设计理念**：将笔画变换功能模块化，支持未来偏旁级别的精细控制

## 4. 拖拽变换组件架构

### 4.1 DragTransformComponent类设计
- **独立封装**：完整封装拖拽变换功能，提高代码复用性
- **状态管理**：自动管理组件初始化状态和字符加载状态
- **D1自动加载**：启动时自动加载D1图片而非D0，确保基于处理后版本进行变形
- **D2生成控制**：通过专用方法控制D2生成流程，包含完整错误处理和统一命名规范

### 4.2 组件功能模块
- **initialize()**：组件初始化，包含网格设置和D1图片加载
- **loadD1Image()**：自动获取当前字符并加载对应D1图片
- **generateD2()**：验证变形状态并触发D2生成，使用时间戳命名格式，包含完整错误处理
- **displayD2Result()**：处理D2生成结果的显示逻辑
- **reset()**：重置组件状态和网格变形状态
- **getState()**：获取组件当前状态信息
- **核心组件**：
  - `BaseTransform`：统一的变换接口，定义apply、validate_params等方法
  - `MoveTransform`：笔画移动变换，支持水平和垂直偏移
  - `TiltTransform`：笔画倾斜变换，支持围绕指定中心点旋转
  - `ScaleTransform`：笔画缩放变换，支持等比和非等比缩放
  - `SmoothTransform`：笔画平滑变换，支持Chaikin和移动平均算法
  - `TransformManager`：变换管理器，统一协调多个变换的执行顺序
- **执行流程**：配置驱动的变换流水线，确保变换效果的一致性和可预测性
- **扩展性**：模块化设计便于添加新的变换类型，为未来偏旁识别和分级变换奠定基础

#### 2.4 风格应用器 (Styler)
- **功能**：应用风格参数到处理后的笔画
- **参数管理**：合并默认配置和用户自定义参数
- **输出**：带风格信息的笔画数据

#### 2.5 SVG渲染器 (Renderer)
- **功能**：生成最终的SVG文件
- **渲染模式**：
  - A: 轮廓模式 (Outlines)
  - B: 中轴填充模式 (Median Fill)
  - C: 原始中轴模式 (Raw Centerline)
  - D0: 基线处理中轴 (Baseline Processed Centerline) - 一个标准化的基线版本，不受Web界面主要风格参数影响，用于提供稳定的对比基准。
  - D1: 用户风格化中轴 (User-Stylized Centerline) - 在D0基础上，应用所有Web界面自定义参数后生成的版本，实时反映用户的风格调整。

### 3. Web服务层 (Web Service Layer)
```
web/
├── app.py                     # Flask应用主入口
├── ui.html                    # 前端界面（已简化，移除日志窗口）
├── config.py                  # Web配置
└── services/
    ├── generation.py          # 生成服务
    ├── style.py               # 风格服务
    └── files.py               # 文件服务
```

#### 3.1 Flask应用架构
- **路由设计**：RESTful API设计（新增 `/api/gen` 与 `/api/gen_single`）
- **会话管理**：基于Cookie的参数持久化
- **异步处理**：支持后台生成任务

#### 3.2 前端架构
- **界面设计**：标签页式参数调整界面，简化设计移除日志窗口
- **实时预览**：AJAX异步更新
- **状态管理**：Cookie持久化用户设置
- **用户体验**：专注核心功能，提供简洁直观的操作界面

### 4. 数据处理管道 (Data Pipeline)
```
mmh_pipeline/
├── scripts/
│   ├── get_mmh.sh/ps1         # 数据获取脚本
│   ├── merge_mmh.py           # 数据合并脚本
│   └── make_subset.py         # 子集生成脚本
└── data/
    └── mmh_raw/               # 原始MMH数据
```

## 数据流架构

### 处理流程图
```
输入汉字 → Parser → Classifier → Centerline → Styler → Renderer → SVG输出
    ↓         ↓          ↓           ↓         ↓         ↓
  Unicode   笔画路径   笔画类型    处理笔画   风格笔画   渲染文件
```

### 详细数据流
1. **输入阶段**：用户输入汉字，系统查找对应的MMH数据
2. **解析阶段**：提取笔画的原始坐标点序列
3. **分类阶段**：识别每个笔画的类型和特征
4. **处理阶段**：应用多阶段几何变换
5. **风格阶段**：根据配置应用视觉风格
6. **渲染阶段**：生成最终的SVG文件

## 关键算法实现

### 1. 角点检测算法
```python
def _find_corner_indices(points, angle_threshold_deg):
    """基于角度阈值的角点检测"""
    # 计算相邻向量夹角
    # 识别超过阈值的转折点
    # 返回角点索引列表
```

### 2. 笔画裁剪算法
```python
def trim_last_segment_by_fraction(points, end_frac_seg3, corner_thresh_deg):
    """基于弧长比例的终点裁剪"""
    # 1. 检测角点，确定第三段起始位置
    # 2. 计算第三段总弧长
    # 3. 根据比例确定裁剪长度
    # 4. 精确插值计算裁剪点
    # 5. 返回裁剪后的点序列
```

### 3. Chaikin平滑算法
```python
def chaikin_smooth(points, iterations=1):
    """Chaikin角点切割平滑算法"""
    # 迭代应用角点切割规则
    # 生成更平滑的曲线
```

## 配置系统架构

### 风格配置结构
```json
{
  "profiles": {
    "default": {
      "start_orientation": {...},
      "end_orientation": {...},
      "trim_settings": {...},
      "smoothing": {...},
      "rendering": {...}
    }
  }
}
```

### 参数继承机制
1. **默认配置**：系统内置的基础参数
2. **用户配置**：从配置文件加载的自定义参数
3. **会话配置**：Web界面的临时覆盖参数
4. **优先级**：会话 > 用户 > 默认

## 扩展性设计

### 1. 模块化插件架构
- 每个处理阶段都可以独立扩展
- 支持自定义处理器插件
- 配置驱动的处理流程

### 2. 渲染器扩展
- 支持多种输出格式（SVG、PNG等）
- 可扩展的渲染模式
- 自定义风格模板

### 3. 数据源扩展
- 支持多种汉字数据源
- 可扩展的字体解析器
- 自定义笔画分类规则

## 性能优化策略

### 1. 缓存机制
- 解析结果缓存
- 处理结果缓存
- 渲染结果缓存

### 2. 并行处理
- 多字符并行生成
- 多阶段流水线处理
- 异步Web请求处理

### 3. 内存管理
- 惰性加载大型数据文件
- 及时释放处理中间结果
- 优化数据结构设计

## 错误处理策略

### 1. 异常处理策略
- 分层异常处理
- 优雅降级机制
- 详细错误信息记录

### 2. 调试和监控
- 控制台错误输出
- 关键节点状态检查
- 性能监控机制

**注意**：系统已移除Web界面的日志窗口功能，专注于核心的字体生成和参数调整功能。

## 网格变形系统架构（2025年1月更新）

### 1. 前端网格变形模块
```
web/js/
├── grid-transform.js          # 网格变形核心逻辑
├── grid-state-manager.js      # 网格状态管理
└── warp.js                    # SVG变形算法库
```

**核心功能**：
- **画布自适应**：动态调整画布尺寸适配容器，排除50px标题栏高度
- **SVG精确定位**：SVG图像填充主要区域，保持纵横比居中显示
- **网格精确覆盖**：网格控制点精确覆盖SVG文字区域，预留60px操作边距
- **状态持久化**：网格变形状态自动保存到localStorage和后端

### 2. 后端网格处理模块
```
src/
├── grid_deformation.py       # 网格变形算法实现
└── svg_processor.py          # SVG处理和变形应用
```

**处理流程**：
- 读取网格变形状态数据
- 应用双线性插值算法进行SVG变形
- 裁剪居中到256×256像素
- 添加白色背景并保存D2文件

### 3. 界面布局优化
- **模态对话框**：网格变形在独立模态窗口中进行
- **标题栏分离**：50px固定高度标题栏，主要内容区域动态适配
- **响应式设计**：支持不同屏幕尺寸和窗口大小变化

## 部署架构

### 1. 开发环境
- 本地Python环境
- 调试模式Web服务
- 热重载支持

### 2. 生产环境
- WSGI服务器部署
- 静态文件服务
- 负载均衡支持

---

**相关文档**：
- [Web界面文档](WEB_INTERFACE.md)
- [笔画处理文档](STROKE_PROCESSING.md)
- [API接口文档](API_REFERENCE.md)
