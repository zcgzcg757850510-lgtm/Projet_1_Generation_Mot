# D2按钮使用文档

## 概述
本页区分两种“D2”语义：
1) 前端按钮 D2（/api/gen_single type=D2）=> 生成“中轴填充（Median Fill）”，用于界面 B 窗口显示。
2) 网格变形 D2（/gen?type=D2 兼容路径）=> 基于最新 D1 与保存的网格状态生成 `_d2.svg`（归档于处理中轴目录）。

## 核心功能
- 按钮 D2（Median Fill）
  - 生成中轴填充SVG，输出：`output/compare/D2_median_fill/`
  - 界面映射到 B 窗口
- 兼容路径 D2（Grid 变形归档）
  - 自动字符推断（从最新 D1）
  - 应用网格变形，裁剪/背景处理
  - 输出时间戳 `_d2.svg`：`output/compare/C_processed_centerline/`

> 注：D1 的网格变形封装现已统一（`apply_grid_deformation_to_svg`），默认使用“超采样栅格化+LANCZOS”保证平滑边缘，可按需关闭以保持矢量。

## D2按钮位置

### 测试窗口D2按钮
- **位置**：测试窗口右下角区域
- **标识**：蓝色"生成D2"按钮
- **功能**：一键生成D2网格变形文件

### 拖拽变换D2按钮
- **位置**：拖拽变换弹窗内的"生成D2"按钮
- **功能**：基于当前网格变形状态生成D2文件

## 使用前提

使用D2按钮前需要满足以下条件：

1. **D1文件存在**：必须先点击"生成对比"按钮生成D1文件
   - 文件位置：`output/compare/C_processed_centerline/`
   - 文件命名：`{timestamp}_{字符}_d1.svg`

2. **字符已输入**：在主界面字符输入框中输入要处理的字符

3. **网格变形（可选）**：如需应用网格变形效果
   - 打开"拖拽变换"弹窗进行网格变形操作
   - 系统会自动保存变形状态

## 操作流程

### 基础D2生成（按钮 D2，无变形）
1. 在字符输入框输入字符（如"的"）
2. 点击"生成对比"按钮生成D1文件
3. 点击测试窗口的"生成D2"按钮
4. 系统自动生成标准D2文件
5. **D2文件自动填充到网格变形(D2)窗口**，可直接查看结果

### 网格变形D2生成（兼容路径 D2）
1. 在字符输入框输入字符
2. 点击"生成对比"按钮生成D1文件
3. 点击"拖拽变换"按钮打开变形弹窗
4. 在网格中拖拽控制点进行变形操作
5. 点击变形弹窗内的"生成D2"按钮
6. 系统生成应用变形效果的D2文件
7. **D2文件自动填充到网格变形(D2)窗口**，可直接查看变形效果

## 按钮功能特点（按钮 D2）

### 一键操作
- **简单易用**：点击按钮即可完成D2生成
- **自动处理**：无需手动传递参数或配置
- **智能推断**：自动识别当前字符和变形状态

### 状态管理
- **自动保存**：网格变形状态自动保存到后端
- **状态恢复**：支持页面刷新后状态恢复
- **实时同步**：变形操作与D2生成实时同步

### 结果反馈
- **即时显示**：生成结果立即在测试窗口显示
- **文件信息**：显示生成的D2文件名和路径
- **自动填充**：D2文件自动加载到网格变形(D2)窗口进行预览
- **错误提示**：清晰的错误信息和解决建议

## 后端处理流程（两条路径）

### 1) 按钮 D2（/api/gen_single type=D2）
- 生成中轴填充，保存到 `D2_median_fill/`，返回URL供 B 窗口显示。

### 2) 兼容路径 D2（/gen?type=D2 或 POST /gen {type:"D2"}）
- 自动推断字符 → 找 D1 → 读取保存的网格状态 → 变形 → `_d2.svg` 输出到 `C_processed_centerline/`。

## 常见问题解决

### 问题1：点击D2按钮无反应
**原因**：D1文件不存在
**解决方法**：
1. 确认已在字符输入框输入字符
2. 点击"生成对比"按钮先生成D1文件
3. 等待D1文件生成完成后再点击D2按钮

### 问题2：D2生成失败
**可能原因**：
- 字符输入框为空
- D1文件损坏或不存在
- 网格状态格式错误

**解决方法**：
1. 检查字符输入框是否有内容
2. 重新生成D1文件
3. 重新进行网格变形操作

### 问题3：网格变形未应用到D2
**原因**：网格状态未正确保存
**解决方法**：
1. 确保在拖拽变换弹窗中进行了变形操作
2. 使用拖拽变换弹窗内的D2按钮而非测试窗口按钮
3. 检查浏览器控制台是否有错误信息

### 问题4：D2生成后网格变形(D2)窗口未显示
**原因**：自动填充功能未正常工作
**解决方法**：
1. 检查D2文件是否成功生成（查看测试窗口的文件信息）
2. 手动刷新页面后重新查看网格变形(D2)窗口
3. 确认网格变形(D2)窗口区域是否可见（可能需要滚动页面）

## 使用技巧

### 最佳实践
1. **按顺序操作**：输入字符 → 生成对比 → 网格变形 → 生成D2 → 查看网格变形(D2)窗口
2. **保存状态**：网格变形后系统会自动保存状态，无需手动操作
3. **检查结果**：D2生成后在测试窗口查看结果文件信息，同时在网格变形(D2)窗口查看视觉效果

### 效率提升
- 同一字符的多次D2生成会自动使用最新的D1文件
- 网格变形状态会持久保存，页面刷新后仍然有效
- 可以先进行多个字符的D1生成，再批量进行网格变形和D2生成

## 文件输出说明

### 输出位置
- 按钮 D2（Median Fill）：`output/compare/D2_median_fill/`（界面 B 窗口）
- 兼容路径 D2（Grid 变形归档）：`output/compare/C_processed_centerline/`（带 `_d2.svg`）

### 文件特点
- **尺寸**：256×256像素
- **背景**：纯白色背景
- **内容**：居中显示的变形字符
- **格式**：标准SVG矢量格式

## 技术说明

### 自动化特性
- **字符识别**：自动从D1文件名推断字符
- **状态管理**：自动保存和恢复网格变形状态
- **文件处理**：自动查找最新D1文件并应用变形
- **结果输出**：自动生成规范化的D2文件

### 网格变形界面优化（2025年1月更新）
- **SVG精确对齐**：SVG图像完全填充主要画布区域，位于标题栏下方
- **网格精确覆盖**：网格控制点精确覆盖SVG文字区域，不再填满整个画布
- **动态尺寸适配**：画布自动适配容器尺寸，SVG保持纵横比居中显示
- **智能定位**：SVG容器自动定位在50px标题栏下方，确保完美布局
- **边距优化**：为网格控制点预留60px边距，确保操作便利性

### 兼容性
- 支持有变形和无变形两种模式
- 兼容所有网格规格（2×2到5×5）
- 支持页面刷新后状态恢复
- 兼容不同浏览器环境
- 支持不同SVG尺寸的自适应显示
