# Web界面文档

## 界面概览

Web界面是Generateur_Mot系统的主要交互方式，提供实时参数调整和五列对比预览功能。界面采用标签页设计，支持参数持久化和自动状态恢复。新增网格变形功能和参数预设管理系统，提供专业的字符生成和参数管理体验。

### 预览卡片统一化架构
- **统一组件系统**：创建PreviewCard类和PreviewCardManager管理器，为5个预览窗口提供统一的UI构建逻辑
- **三种卡片类型**：支持simple（简单图片）、compare（对比滑块）、transform（变形指示）三种预览卡片类型
- **向后兼容性**：通过ID映射机制确保现有代码能正常工作，自动设置兼容性元素引用
- **模块化管理**：统一的事件绑定、状态管理、图片加载和错误处理机制

### 标签页状态管理优化
- **闪烁问题修复**：解决页面刷新时标签页闪烁问题，移除HTML中的默认active状态，完全由JavaScript控制标签页切换
- **初始化时序优化**：在DOM解析完成后立即清除所有按钮状态并恢复正确的标签页，避免显示错误的默认标签页
- **多重初始化保障**：使用`DOMContentLoaded`和`readystatechange`事件确保标签页管理器在各种加载情况下都能正确初始化

### 前端架构模块化 (2025-08)
系统完成了全面的前端模块化重构，实现了CSS、HTML、JavaScript的分离和模块化管理：

#### CSS模块化架构
- **`css/base.css`** - 基础样式：CSS变量、重置样式、布局、滚动条隐藏
- **`css/components.css`** - 组件样式：标签页、表单、按钮、复选框、工具提示
- **`css/toast.css`** - 提示样式：多类型toast（success/error/warning/info/loading）
- **`css/modal.css`** - 模态框样式：弹窗基础样式、标题栏、内容区
- **`css/preview-cards.css`** - 预览卡片：ABCD1D2预览区域、悬停效果、高亮
- **`css/dropdown.css`** - 下拉菜单：预设控件、选项、分割线

#### HTML模板化系统
- **`html/modals/preset-modal.html`** - 预设管理弹窗模板
- **`html/modals/article-modal.html`** - 文章生成弹窗模板  
- **`html/modals/grid-transform-modal.html`** - 网格变形弹窗模板
- **`html/modals/image-modal.html`** - 图像预览弹窗

#### JavaScript模块化架构修复完成
项目已完成ES6模块化架构的修复和验证，成功将ui.html中的所有内联JavaScript代码完全模块化为13个独立模块：

#### 核心功能模块
- **generation-manager.js**: 字符生成管理、对比功能、图像模态框、画布绘制和缩放
- **generation-service.js**: 后端交互、生成逻辑、结果处理和API通信
- **preview-manager.js**: 图像和SVG预览管理、D0/D1/D2文件加载、预览刷新
- **grid-transform.js**: SVG网格变形、控制点管理、状态持久化、Photoshop风格Coons Patch变形
- **params-manager.js**: 参数重置、预览卡片悬停效果、参数状态管理
- **test-utils.js**: ToastManager提示系统、测试信息显示、调试工具和系统监控

#### 基础支撑模块
- **utils.js**: 通用工具函数、Cookie管理、状态保存、字符处理
- **state-manager.js**: 全局状态管理、模块间通信、事件系统
- **preset-modal.js**: 预设管理弹窗逻辑、预设CRUD操作
- **modal-loader.js**: 动态模态框加载器、HTML模板管理
- **modal-manager.js**: 模态框统一管理、生命周期控制
- **mesh-deformation.js**: 网格变形算法、几何计算
- **preview-effects.js**: 预览特效处理、动画效果

### 修复和验证成果
- **模块导出修复**: 修复所有模块的全局变量导出，确保模块间正确通信
- **功能完整性验证**: 创建专用测试页面验证所有13个模块的加载和功能
- **开发环境就绪**: HTTP服务器成功启动，前端开发环境完全可用
- **系统稳定运行**: 所有核心功能（网格变形、预览管理、提示系统等）运行正常

### 架构优势
- **完全模块化**: 彻底消除内联JavaScript，实现真正的模块化架构
- **清晰的关注点分离**: 每个模块专注特定功能领域，职责明确
- **高度可维护性**: 独立开发、测试、调试各个模块，便于团队协作
- **性能优化**: 支持按需加载和并行加载，主页面体积减少约70%
- **向后兼容**: 保持所有现有API和功能不变，用户体验无缝过渡

#### 架构优势
- **性能优化** - 主页面体积减少70%，支持并行加载和按需加载
- **维护性** - 关注点分离，独立维护，便于团队协作
- **扩展性** - 模块化结构便于添加新功能和样式
- **向后兼容** - 保持所有现有功能和API不变
- **代码清晰** - 移除所有内联JavaScript代码块，实现完整ES6模块化

### 字符输入与状态管理
- **字符编码处理**：系统现在正确处理中文字符的URL编码/解码，确保字符输入框显示实际汉字而非编码字符
- **自动保存功能**：字符输入变化时自动保存到Cookie和localStorage，支持状态恢复
- **标签页状态持久化**：用户选择的标签页（如"处理中轴"）会被记忆，刷新页面后直接进入上次选择的标签页
- **禁止下拉滑动**：通过CSS `overscroll-behavior:none` 和JavaScript事件监听器禁止界面下拉刷新和过度滚动
- **编码兼容性**：修复了Cookie中URL编码字符（如%E9%9D%9E）的解码问题，提升用户体验

## 界面布局

### 主要区域
```
┌─────────────────────────────────────────────────────────┐
│ 标题栏：基于 Make Me a Hanzi 的可控手写风格生成系统        │
├─────────────────────────────────────────────────────────┤
│ 输入区：[字符输入框] [D1] [D2] [网格变形] [重置参数] [📋 预设管理] │
├─────────────────────────────────────────────────────────┤
│ 标签页：原始中轴 | 起笔+笔锋（C） | 中间              │
├─────────────────────────────────────────────────────────┤
│ 参数调整区：根据当前标签页显示对应参数控件                │
├─────────────────────────────────────────────────────────┤
│ 预览区：五列对比显示 A/B/C/D1/D2 五种渲染模式（含鼠标高亮） │
├─────────────────────────────────────────────────────────┤
│ 测试窗口：显示调试信息、D2生成结果、系统状态等            │
└─────────────────────────────────────────────────────────┘
```

### 测试窗口功能
- **调试信息显示**：实时显示D2生成结果、网格变形状态、参数调试信息
- **系统状态监控**：显示当前字符、网格初始化状态、预设管理器状态等
- **内容复制功能**：支持一键复制测试窗口内容，便于问题排查
- **自动初始化**：页面加载时自动显示系统状态和功能检查结果
- **D2生成状态**：显示D2生成过程、成功/失败状态、错误详情和文件路径信息

## 网格变形功能

### 功能概述
网格变形功能提供类似Photoshop网格变换的专业变形体验，通过拖拽网格控制点实现SVG字符的实时变形。

### 核心特性
1. **多种网格规格**
   - 支持2×2与3×3两种网格密度（默认3×3）
   - 实时切换网格规格，自动重新创建控制点
   - **网格规格持久化**：网格大小选择自动保存，页面刷新后正确恢复用户上次选择的规格

2. **智能状态管理**
   - 自动保存网格控制点位置和变形状态
   - 页面刷新后自动恢复上次的变形状态
   - **规格恢复优化**：优先从UI选择器和localStorage恢复网格大小，避免总是显示4×4默认网格
   - 支持状态导出和导入功能

3. **实时变形预览**
   - 拖拽控制点时实时显示变形效果
   - 采用Photoshop风格的Coons Patch曲面：边界使用Catmull‑Rom样条平滑、内部使用Coons双边界混合
   - 单元格微细分与三角仿射采样，消除接缝与“九宫格错位”问题

4. **完整的D1集成**
   - 网格变形直接影响D1生成结果
   - 自动检测变形状态并应用到后端处理
   - 支持所有网格规格的变形集成显示切换：显示/隐藏网格线
   - 变形强度调节：控制变形程度

### 界面布局
- **左侧控制面板**：网格设置、变形强度、功能按钮
- **主画布区域**：SVG显示、网格覆盖层、控制点
- **工具栏**：重置、应用、关闭按钮

### 参数预设管理系统

### 功能概述
参数预设管理系统通过"📋 预设管理"按钮触发，点击后打开完整的预设管理弹窗，提供专业的参数保存、加载和管理功能，支持所有界面参数和网格变换状态的持久化管理。

### 核心特性
1. **全面参数覆盖**
   - **起笔参数**：起笔角度、起笔裁剪等设置
   - **中间参数**：细化次数、平滑窗口、笔画倾斜、缩放、移动等
   - **笔锋参数**：收笔角度、收笔裁剪等设置
   - **原始中轴参数**：三色分段、短边全紫等设置
   - **处理中轴参数**：夹角范围等设置
   - **网格变形参数**：控制点位置、网格密度选择
   - **界面状态**：当前激活标签页、字符输入等

2. **预设管理弹窗布局**
   - **左侧保存面板**：输入预设名称和描述，预览当前参数，一键保存所有参数状态
   - **右侧管理面板**：预设列表显示、搜索过滤、导入导出功能
   - **统一设计风格**：与文章生成弹窗保持一致的布局和交互体验
   - **按钮布局优化**：居中对齐的按钮组，统一的间距和样式
   - **预设列表优化**：固定高度的滚动区域，清晰的占位提示

3. **本地存储持久化**
   - 使用localStorage自动保存预设数据
   - 支持预设的增删改查操作
   - 自动显示保存时间和描述信息

4. **智能恢复功能**
   - 加载预设时自动恢复标签页状态
   - 自动应用网格变形参数和控制点位置
   - 自动刷新预览以显示加载后的效果

### 使用流程
1. 调整各种参数（起笔、笔锋、网格变形等）
2. 点击"📋 预设管理"按钮打开管理弹窗
3. 输入预设名称并保存当前状态
4. 通过预设列表快速加载不同预设
5. 在管理界面中查看、加载、删除或重命名预设

## 预览区域交互效果

### 鼠标跟随高亮
预览区域（A/B/C/D1/D2）实现了现代化的鼠标跟随径向高亮效果：

1. **径向遮罩**：25rem半径的圆形高亮区域跟随鼠标移动
2. **彩色主题**：每个预览卡片有独特的HSL颜色变量
3. **平滑过渡**：400ms的mask过渡动画
4. **性能优化**：overlay层只包含结构容器，不复制内容

## D1处理中轴生成

D1方案在D0基础上应用用户定义的风格化参数：

### 处理流程
1. **中轴线优化**：基于用户参数调整中轴线
2. **风格化渲染**：应用颜色、粗细等风格参数
3. **几何变换**：倾斜、缩放、平滑等变换
4. **网格变形集成**：自动检测并应用网格变形效果
5. **输出生成**：生成最终的SVG文件

## D2网格变形生成

D2方案基于D1结果应用网格控制点变形，采用完全封装的后端处理流程：

### D2按钮完整调用流程
#### 前端操作
1. **网格状态保存**：检测并保存网格变形状态到临时文件 (`/save_grid_state`)
2. **纯接口调用**：发送空参数到 `/save_d2` 接口
3. **结果显示**：在测试窗口显示生成结果或错误信息

#### 后端自动处理
1. **字符推断**：从最新D1文件名自动推断字符
2. **状态读取**：从临时文件读取网格状态和画布尺寸
3. **D1文件搜索**：自动找到对应字符的最新D1 SVG文件
4. **网格变形应用**：使用双线性插值算法应用变形效果
5. **SVG处理**：裁剪居中到256×256，添加白色背景
6. **文件保存**：生成时间戳文件名并保存到 `output/compare/C_processed_centerline/`

#### 使用方法
```javascript
// 前端只需调用一个函数
generateD2WithNewInterface();
```

#### 技术特点
- **完全封装**：前端无需传递任何参数
- **自动推断**：后端自动获取所有必要参数
- **状态持久化**：网格状态自动保存和恢复
- **向后兼容**：支持新旧两种调用方式
- **错误处理**：完善的异常处理和用户提示

### 变形数据流（已优化）
1. **前端网格状态收集**：`GridStateManager.getState()`获取控制点位置
2. **变形检测**：`GridStateManager.hasDeformation()`检查是否有实际变形
3. **状态持久化**：通过`/save_grid_state`保存到后端临时文件
4. **后端自动处理**：`/save_d2`接口完全封装所有处理逻辑
5. **D1文件智能查找**：自动搜索最新D1文件作为变形基础
6. **D2文件生成**：使用时间戳格式`{timestamp}_{char}_d2.svg`命名
7. **文件兼容性**：自动清理CSS样式属性，确保在各种SVG查看器中正常显示

### 坐标系转换
- **SVG坐标系**：0-256像素范围
- **网格画布坐标系**：800×600画布，300×300网格区域
- **SVG映射区域**：网格中央80%区域（240×240）
- **双线性插值**：基于四个邻近控制点计算变形位移

### 技术修复要点
- **前端变形函数**：移除对`backgroundImage`的依赖，直接使用坐标系映射
- **后端算法统一**：与前端使用相同的坐标系转换逻辑
- **变形检测优化**：基于控制点标准位置计算实际偏移量
- **调试日志完善**：详细的变形过程追踪便于问题诊断
- **用户反馈优化**：实现右下角弹窗提示系统，D2生成成功显示绿色提示，失败显示红色提示，提升用户体验

### 使用流程
1. 点击"拖拽变换"按钮打开网格变形界面
2. 点击"加载当前字符"加载SVG字符
3. 选择合适的网格大小（推荐4×4）
4. 拖拽网格控制点进行变形
5. 调整变形强度获得理想效果
6. 点击"应用"保存变形结果

### 技术实现
- Canvas绘制网格和控制点
- SVG路径实时变换
- 双线性插值算法
- 坐标系转换和映射

### D1 目标与两阶段封装（中文）
- **目标**：统一封装“网格变形 → D1生成”。输入：C图SVG + grid_state；输出：平滑的 D1 SVG 文件。
- **阶段1（仅数据）**：在“网格变形”窗口拖动控制点，仅保存并同步网格状态到后端（`POST /save_grid_state`），不写入 D1 文件。
- **阶段2（生成文件）**：点击“D1”按钮后，后端读取 grid_state 并对 C 图做统一变形（`apply_grid_deformation_to_svg`），将结果放到 256×256 白底画布后输出到 `output/compare/D1_grid_transform/`。
- **平滑策略**：默认启用“矢量高精度变形 → 2048px 栅格化 → LANCZOS 下采样到 256px”的超采样流程，以 `<image>` 形式嵌入SVG，获得与Canvas相近的平滑边缘（可通过参数关闭以保持100%矢量）。
- **前端配合**：
  - 网格窗口：每次保存会自动 `POST /save_grid_state`（同步 grid_state，仅数据）。
  - D1 按钮：`POST /api/gen_single { char, type:'D1', grid_state? }`，若未传，后端优先读取已保存状态。

## 标签页详解

### 1. 起笔+笔锋（C） 标签页（合并“起笔/笔锋/处理中轴角点范围”）
**功能**：统一控制笔画起始与结束部分的处理参数，以及处理中轴角点范围（夹角范围）

**参数控件**：
- **起笔方向调整** (`start_orientation`)
  - `enabled`: 是否启用起笔方向调整
  - `target_angle_deg`: 目标角度（度）
  - `influence_frac`: 影响范围比例 (0.0-1.0)
  - `strength`: 调整强度 (0.0-1.0)

- **起点裁剪** (`start_trim`)
  - `start_trim`: 裁剪比例 (0.0-1.0)
  - 建议范围：0.1-0.3，过大会影响字形识别

 - **夹角范围（处理中轴）** (`corner_thresh_min_deg` / `corner_thresh_max_deg`)
   - 启用：勾选“夹角范围”
   - 作用：限定首/末折点在 Raw 前/后窗口内的候选角度范围
   - 范围建议：35–179（默认更宽），强调钝角：90–179；更多折点：65–150

### 2. 中间标签页
**功能**：控制笔画中间段的处理参数

**参数控件**：
- **平滑处理** (`smoothing`)
  - `chaikin_iterations`: Chaikin平滑迭代次数
  - `enabled`: 是否启用平滑

- **重采样** (`resampling`)
  - `target_spacing`: 目标点间距
  - `enabled`: 是否启用重采样

- **几何变换**
  - `tilt_deg`: 倾斜角度（度）
  - `scale_factor`: 缩放因子

（已合并入“début+fin de trait（C）”标签页）

### 4. 预览标签页
**功能**：显示生成参数摘要和快速预览

**内容**：
- 当前参数配置摘要
- 生成状态信息
- 快速操作按钮

### 5. 原始中轴标签页
**功能**：显示原始中轴线渲染结果（C模式）

### 6. 处理中轴 (D0/D1) 标签页
（界面上不再单独作为一个参数页；角点范围相关设置已并入“début+fin de trait（C）”。此节描述输出含义保持不变。）

## 功能按钮

### 生成对比
- **功能**：根据当前参数生成四列对比结果
- **处理流程**：
  1. 清空现有预览
  2. 收集所有参数
  3. 发送生成请求到后端
  4. 更新预览区域

### 文章生成
- **功能**：打开文章生成模态框
- **特性**：支持多行文本、字体大小调整、间距设置等

### Warp.js变形演示
- **功能**：专业的SVG变形演示系统，展示Warp.js库的完整变形能力
- **演示特性**：
  - **多种变形方法**：
    - Grid Deformation：Warp.js原生网格变形算法
    - Custom Transform：自定义变换函数演示
    - Inverse Distance Weighting：反距离权重插值方法
  - **3x3控制点网格**：提供9个交互控制点，覆盖演示区域
  - **实时方法切换**：下拉菜单选择不同变形算法，立即应用效果
  - **随机变形功能**：一键生成随机变形效果，展示算法能力
  - **控制点交互**：
    - 拖拽红色控制点进行实时变形
    - 双击控制点重置到原始位置
    - 拖拽时控制点变为深红色并放大
- **演示内容**：
  - 渐变背景圆形和装饰性SVG图形
  - 复杂路径和几何形状的变形展示
  - "Warp.js Demo"文字标签
- **界面设计**：
  - 左上角信息面板：操作说明和功能介绍
  - 右下角方法指示器：显示当前使用的变形方法
  - 底部控制面板：重置、随机变形、切换网格等功能
  - 方法选择器：实时切换不同的Warp.js变形算法
- **技术实现**：
  - 完全基于Warp.js原生API实现
  - 展示三种不同的变形算法实现方式
  - 实时性能优化，流畅的交互体验
  - 清理旧的网格变形代码，专注演示功能

### 刷新预览
- **功能**：重新生成当前字符的四列对比结果
- **用途**：参数调整后快速查看效果

### 重置参数
- **功能**：将所有参数重置为默认值
- **影响范围**：所有标签页的参数控件

## 技术特性

### 参数持久化
- 使用Cookie保存用户设置
- 页面刷新后自动恢复参数状态
- 标签页状态自动记忆

### 自动加载功能
- 页面加载时自动恢复上次使用的字符
- 检测并显示已存在的SVG文件
- 标签页状态无缝恢复

### 响应式设计
- 适配不同屏幕尺寸
- 模态框居中显示
- 移动端友好的交互设计

### D1/D2处理流程

系统现在支持更清晰的 D1 与 D2 职责划分：

**D1（处理中轴，支持网格变形）**：
1. 使用用户设置的风格参数生成处理中轴（基于 C 处理中轴数据）
2. 若前端提供 `grid_state`，对当前 C 的SVG应用网格变形；否则保持未变形版本
3. 结果文件保存到 `output/compare/D1_grid_transform/`（用于界面 D2 窗口展示）
4. 用于与 D0 基线进行对比（颜色分段与 D0 保持一致）

**D2（两条来源）**：
1. 界面“D2”按钮（/api/gen_single type=D2）：生成“中轴填充（Median Fill）”，结果保存到 `output/compare/D2_median_fill/`，用于界面 B 窗口
2. 网格变形工作流（/gen?type=D2）：基于最新 D1 与保存的网格状态，输出带时间戳的 `_d2.svg` 到 `output/compare/C_processed_centerline/`（兼容旧流程）
3. 两者用途不同：前者是填充预览（B窗口），后者是网格变形结果归档（兼容路径）

**技术实现细节**：
- **数据流**：前端网格状态 → Flask处理 → style参数 → D2生成
- **状态检测**：动态计算标准网格位置，精确检测控制点偏移
- **错误处理**：完整的格式验证和异常处理机制
- **调试支持**：详细的D2生成过程日志

这种设计确保：
- D1保持标准效果，便于对比
- D2专门展示网格变形效果
- 用户可以同时查看原始和变形版本
- 网格变形功能稳定可靠

## 使用建议

### 参数调整策略
1. **起笔调整**：先设置起笔方向和裁剪，建立基本笔画形态
2. **中间处理**：调整平滑和重采样，优化笔画质量
3. **笔锋设计**：最后调整终笔方向和裁剪，完善笔画收尾
4. **网格变形**：对生成的D0字符进行局部微调

### 最佳实践
- 参数调整应循序渐进，避免过度调整
- 经常使用"刷新预览"查看效果
- 利用Cookie持久化功能保存常用设置
- 网格变形适合进行细微的局部调整

#### Warp.js集成
- **专业库支持**：使用开源的Warp.js库进行SVG变形处理
- **高质量变形**：替代手动算法，提供更稳定和高质量的变形效果
- **路径密度优化**：自动增加SVG路径密度，提升变形精度
- **性能优化**：更高效的变形算法，减少计算负载

#### 局部权重影响
- **距离衰减算法**：每个控制点只影响其影响半径内的区域
- **二次衰减函数**：使用 `weight = (1 - distance/radius)^2` 确保平滑过渡
- **多点叠加**：多个控制点的影响可以叠加，实现复杂变形
- **智能坐标转换**：自动处理SVG坐标系与画布坐标系的转换

#### D0 SVG操作
- **基础版本加载**：直接加载和显示D0 SVG（基础版本）
- **避免界面效果**：不受用户界面效果干扰，变形更纯粹
- **实时变形**：基于Warp.js的实时SVG变形处理
- **自动重置**：新SVG加载时自动重置Warp实例

#### 网格变形功能
- **位置**：网格变形按钮
- **功能**：
  - 打开交互式网格变形界面
  - 支持2×2到5×5网格密度选择
  - 拖拽控制点进行局部变形
  - 实时预览变形效果
  - **自动保存**：拖动控制点时实时保存状态
  - **状态恢复**：重新打开界面时自动恢复上次操作
  - 状态持久化保存，页面刷新后自动恢复

### 刷新预览
- **功能**：手动刷新预览区域
- **用途**：当自动更新失效时手动触发

### 重置参数
- **功能**：恢复所有参数到默认值
- **操作**：
  1. 清除相关Cookie
  2. 重置界面控件
  3. 保留字符输入内容

## 预览窗口功能

### 预览窗口

点击任意图像可放大预览。预览窗口占用95%视口空间，图像居中且最大化显示。

**#### A图定位优化
- 修正A图（轮廓）SVG变换矩阵的Y偏移计算
- 采用固定Y偏移值220，简化算法逻辑
- 确保与B/C/D图完美对齐

**D图左右对比模式**：
- D图（处理中轴）支持左右滑动对比功能
- 左侧显示D0图（基线），右侧显示D1图（用户风格化）
- 黄色分割线可拖拽调整对比位置
- 便于观察用户风格化效果与基线的差异

**B图对比功能**：
- B图（中轴填充）点击放大时，若存在D0图，自动开启左右对比模式
- 左侧显示B图（中轴填充），右侧显示D0图（处理中轴基线）
- 使用相同的黄色分割线拖拽交互
- 便于观察中轴填充与处理中轴的差异对比

## 四列对比预览

### A列：轮廓模式 (Outlines)
- **特点**：显示笔画轮廓边界
- **用途**：查看笔画的整体形状和边界

### B列：中轴填充模式 (Median Fill)
- **特点**：中轴线加粗填充显示
- **用途**：查看笔画的中轴路径和宽度变化

### C列：原始中轴模式 (Raw Centerline)
- **特点**：显示未经处理的原始中轴线
- **用途**：对比处理前后的差异

### D列：处理中轴模式 (D0/D1)
- **概念**：此列展示经过风格化处理的中轴线，分为D0（基线）和D1（用户风格化）两个版本。
- **D0 (基线处理中轴)**：
    - **特点**：一个标准化的基线版本，它**完全隔离**于Web界面中所有用户可调参数。
    - **隔离机制**：强制重置所有变换参数为固定默认值，包括：
      - 几何变换：倾斜、缩放、移动归零
      - 角度调整：起笔角度、笔锋角度禁用
      - 平滑处理：Chaikin迭代、移动平均重置
      - UI控制：三色窗口、分段冻结等移除
    - **用途**：提供一个稳定、一致的对比基准。
- **D1 (用户风格化中轴)**：
    - **特点**：使用原始用户参数生成，完全独立于D0处理流程。
    - **文件命名**：使用`_d1.svg`后缀区分，如`20250819-024950-533_文_d1.svg`。
    - **用途**：反映用户的实时风格调整，是最终风格化的输出。
    - **处理顺序**：D1采用特定的处理流程：`起笔` -> `笔锋` -> `中间`。
    - **网格变形集成**：D1生成过程中自动应用保存的网格变形状态，实现完整的变形到输出流程。
    - **文章生成**：文章SVG合成功能基于D1字符SVG，确保风格一致性。
    - **颜色优化**：文章SVG中所有字符线条统一为纯黑色（#000000），消除三色分段显示，提升文字清晰度和打印效果。
    - **文件管理**：每次生成前自动清理旧的文章SVG文件，避免文件累积。
    - **预览显示**：生成的文章SVG直接在Web界面预览区域显示，支持SVG格式下载。
    - **路由访问**：通过`/compare/articles/<filename>`路由提供SVG文件，设置正确的MIME类型。
- **界面显示**：
    - D列默认显示 **D1** 的结果，以实时反馈用户操作。系统内部同时生成D0用于对比，但UI上可能不直接展示。
- **分段着色机制**：
  - **D0基线版本**：独立检测折点（角度范围35°–179°），建立分段边界
  - **D1用户版本**：始终使用D0的分段信息（fixed_info），确保与D0颜色完全一致
  - **颜色方案**：蓝色（起笔段）、灰色（中间段）、红色（笔锋段）
  - **重要**：D1不再依赖"固定分段边界"选项，始终与D0保持相同的分段颜色
- **交互功能**：点击可放大查看细节。

## 参数持久化机制

### Cookie存储
系统使用Cookie保存用户的参数设置，实现跨会话的参数持久化。

**存储的参数**：
- 所有标签页的参数设置
- 当前活跃标签页
- 上次使用的字符

**Cookie命名规则**：
- `activeTab`: 当前标签页
- `last_char`: 上次使用字符
- `param_*`: 各种参数值

### 自动恢复机制
页面加载时自动执行：
1. 恢复标签页状态
2. 恢复参数设置
3. 恢复字符输入
4. 检查并加载现有SVG文件

## 交互流程

### 典型使用流程
1. **打开页面**：自动恢复上次状态
2. **输入字符**：在输入框中输入要生成的汉字
3. **调整参数**：在各标签页中调整相关参数
4. **生成预览**：点击"生成对比"按钮
5. **查看结果**：在四列预览区查看生成结果
6. **细调参数**：根据预览结果进一步调整
7. **重复优化**：重复步骤4-6直到满意

### 参数调整策略
- **起笔调整**：影响笔画开始部分的角度和形状
- **中间处理**：影响笔画的平滑度和整体形状
- **笔锋调整**：影响笔画结束部分的角度和长度
- **裁剪功能**：精确控制笔画的起点和终点位置

## API接口

### 主要端点
- `GET /`: 主页面
- `POST /api/gen`: 一次性生成 A/B/C/D1(/D2)
- `POST /api/gen_single`: 生成单个类型（A/B/C/D1/D2），D1可附带 `grid_state`
- `GET/POST /gen`: 兼容路径；POST `type=D2` 用于网格变形旧流程
- `GET /status`: 检查文件状态
- `GET /compare/*`: 预览文件访问

### 界面窗口与后端类型映射
- A → A窗口（`/compare/A_outlines/`）
- B（Raw）→ C窗口（`/compare/B_raw_centerline/`）
- C（Processed）→ D1窗口（`/compare/C_processed_centerline/`）
- D1（Grid变形结果）→ D2窗口（`/compare/D1_grid_transform/`）
- D2（Median Fill）→ B窗口（`/compare/D2_median_fill/`）

### 请求格式
```javascript
// 生成请求
fetch('/gen', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        text: '字',
        seed: 42,
        params: {...}
    })
})
```

### 响应格式
```json
{
    "status": "success",
    "urls": {
        "A": "/compare/A_outlines/字_42.svg",
        "B": "/compare/D2_median_fill/字_42.svg",
        "C": "/compare/B_raw_centerline/字_42.svg",
        "D": "/compare/C_processed_centerline/字_42.svg"
    }
}
```

## 调试功能

### 浏览器控制台日志
系统在浏览器控制台输出详细的调试信息：
- 参数收集过程
- 请求发送状态
- 响应处理结果
- 错误信息

### 后端日志
后端服务器记录详细的处理日志：
- 参数接收和解析
- 处理流程追踪
- 性能监控信息

## 故障排除

### 常见问题

**1. 预览不显示**
- 检查字符是否在MMH数据中存在
- 查看浏览器控制台错误信息
- 确认后端服务正常运行

**2. 参数不生效**
- 确认参数值在有效范围内
- 检查Cookie是否正常保存
- 尝试重置参数后重新设置

**3. 生成速度慢**
- 减少平滑迭代次数
- 降低重采样密度
- 检查系统资源使用情况

### 性能优化建议
- 合理设置参数范围，避免极端值
- 定期清理浏览器缓存
- 使用推荐的参数组合

---

**相关文档**：
- [技术架构文档](ARCHITECTURE.md)
- [笔画处理文档](STROKE_PROCESSING.md)
- [API接口文档](API_REFERENCE.md)
