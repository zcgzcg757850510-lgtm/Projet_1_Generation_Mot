# 基于 Make Me a Hanzi 的可控手写风格生成系统

## 🎯 核心功能

### 字符生成流程
根据界面上各个预览窗口的实际标题定义：
1. **A方案 - 轮廓**: 从汉字图像中提取精确轮廓线
2. **B方案 - 原始中轴**: 提取字符的骨架中轴线数据
3. **C方案 - 处理中轴**: 优化后的中轴线，支持风格化处理和用户参数
4. **D1方案 - 网格变形**: 基于处理中轴的网格变形处理
5. **D2方案 - 中轴填充**: 基于中轴线的填充渲染

### 高级特性
- **🎨 风格化处理**: 多种笔画风格和颜色方案
- **📐 几何变换**: 支持倾斜、缩放、平滑等变换
- **🔧 参数调优**: 丰富的参数控制，精确调节生成效果
- **📊 实时预览**: 即时查看参数调整效果
- **💾 批量处理**: 支持文章级别的批量字符生成
- **🌐 网格变形**: 交互式网格控制点变形系统

## 近期更新

### 按钮功能重新分配和模块化重构 (最新)
- **按钮功能明确化**：将原有的复合按钮分解为专门的单功能按钮，按界面窗口标题对应：
  - **B按钮**：专门生成原始中轴数据
  - **C按钮**：专门生成处理中轴线（应用用户参数）
  - **D1按钮**：专门生成网格变形版本
  - **D2按钮**：专门生成中轴填充渲染
  - **全部按钮**：生成A、B、C、D1、D2完整对比
- **模块化架构优化**：遵循项目模块化规范，创建独立的JavaScript模块
  - 新建 `web/js/button-generation.js` 模块处理所有按钮生成逻辑
  - 删除ui.html中的内联JavaScript代码，提升代码组织性
  - 统一错误处理和用户反馈机制
- **API接口完善**：新增专用的单图像生成API
  - `/api/gen_single`: 支持按需生成指定类型的单个图像
  - `/api/gen`: 优化的全图像生成接口
  - 避免Flask路由冲突，提升系统稳定性
- **图像类型定义修正**：根据界面窗口实际标题更正文档定义
  - 按照界面标题重新映射：A(轮廓)→B(原始中轴)→C(处理中轴)→D1(网格变形)→D2(中轴填充)
  - 修正了之前文档与界面不符的问题，确保文档准确反映实际功能

### Canvas自适应SVG尺寸优化
- **智能Canvas尺寸**：Canvas现在根据SVG实际尺寸自动调整，而不是使用固定尺寸
- **完美居中显示**：SVG图像在窗口中完全居中显示，提升视觉体验
- **网格精确对齐**：网格控制点现在精确覆盖SVG显示区域，提高变形精度
- **自动缩放适配**：大尺寸SVG自动按比例缩放以适合容器，保持清晰度
- **边距智能预留**：为网格控制点预留60px边距，确保操作区域可见

### 网格规格保存修复
- **修复网格大小持久化**：解决了每次刷新页面网格变形界面总是显示4×4网格的问题
- **智能规格恢复**：网格大小选择器现在能正确恢复用户上次选择的规格（2×2到5×5）
- **优化初始化逻辑**：改进`getDefaultGridState()`函数，优先从UI选择器和localStorage获取网格大小
- **增强状态管理**：新增`restoreGridSizeSelector()`函数，确保网格规格在各种情况下都能正确恢复
- **完善保存机制**：网格大小变更时立即保存到localStorage，确保用户选择不丢失

### 网格变形状态持久化完善
- **修复自动保存功能**：解决了拖动网格控制点时不自动保存状态的问题
- **完善状态恢复**：修复重新进入界面时不恢复上次操作的问题
- **优化保存机制**：移除节流限制，确保每次拖动都实时保存
- **增强用户反馈**：添加保存和恢复成功提示，提升用户体验

### 网格变形界面修复
- **修复网格显示问题**：解决了网格变形界面不显示网格的问题
- **优化初始化流程**：在模态框打开时自动调用网格系统初始化
- **完善用户体验**：确保网格线和控制点正确显示

### D2生成修复
- **修复D2生成失败问题**：解决了"undefined"和"D1生成失败，无法继续D2生成"的错误
- **优化文件路径处理**：修复URL编码和路径分隔符问题，支持中文字符
- **增强后端路由**：添加`/gen`路由对`type=D2`参数的支持
- **性能优化**：避免重复生成，重用现有D1文件
- **完善静态文件服务**：添加`/output/compare/C_processed_centerline/`路径支持

### 文章SVG颜色优化
- **统一线条颜色**：文章生成的SVG中所有字符线条现在统一为纯黑色
- **提升清晰度**：消除三色分段显示，改善打印效果和可读性

### D2生成功能修复完成 ✅
- **D2生成路由修复**：修复`/gen`路由不支持`type=D2`参数的问题，添加专用D2生成处理函数
- **参数兼容性增强**：支持多种参数格式（`ch`/`char`、`grid_state`/`gridState`），提升前后端兼容性
- **网格变形集成**：D2生成完整支持网格变形功能，有网格状态时应用变形，无网格状态时复制D1作为D2
- **错误处理优化**：添加详细的错误日志和状态检查，提供清晰的失败原因反馈
- **文件管理完善**：自动创建D2输出目录，规范化文件命名格式（时间戳_字符_d2.svg）

### 前端JavaScript模块化修复和验证完成 ✅
- **模块化清理完成**：彻底移除ui.html中所有内联JavaScript代码，完成完全模块化
- **模块导出修复**：修复所有JavaScript模块的全局变量导出问题，确保模块间正确通信
- **功能验证通过**：创建专用测试页面，验证所有13个模块的加载和功能完整性
- **开发环境就绪**：成功启动HTTP服务器，前端开发环境完全可用
- **系统稳定运行**：所有核心功能模块（网格变形、预览管理、提示系统等）运行正常
  - **生成管理模块** (generation-manager.js)：统一管理字符生成、对比功能、图像模态框等核心生成逻辑
  - **生成服务模块** (generation-service.js)：封装D2生成、文章生成、结果显示等核心业务逻辑
  - **预览管理模块** (preview-manager.js)：统一管理图片预览、SVG加载、测试窗口等界面功能
  - **测试工具模块** (test-utils.js)：封装ToastManager、测试信息显示、调试功能等工具
  - **参数管理模块** (params-manager.js)：处理参数重置、预览卡片悬停效果等参数相关功能
- **CSS模块化**：将ui.html中的内联CSS抽离为6个独立模块文件（base.css、components.css、toast.css、modal.css、preview-cards.css、dropdown.css）
- **HTML模板化**：将所有弹窗HTML代码抽离为独立模板文件，支持动态加载
  - **工具函数库** (utils.js)：提供Cookie管理、状态保存、调试工具等通用功能
  - **状态管理系统** (state-manager.js)：实现全局状态管理和模块间通信协调
- **文件结构优化**：建立清晰的css/、html/modals/、js/目录结构，提升代码组织性
- **性能优化**：主页面体积减少约70%，支持并行加载和按需加载，大幅提升初始加载速度
- **维护性提升**：关注点分离，独立维护，便于团队协作和功能扩展
- **向后兼容**：所有现有功能完全保留，API调用方式不变，视觉效果一致

### 界面交互体验优化 (2025-08)
- **预览卡片统一化**：重构5个预览窗口（A/B/C/D1/D2）采用统一的UI构建逻辑和交互行为，创建PreviewCard组件系统实现模块化管理
- **标签页闪烁问题修复**：解决页面刷新时先跳转到"原始中轴"再切换到保存标签页的闪烁问题，现在直接显示正确的标签页
- **标签页状态持久化**：修复标签页恢复机制，用户选择"处理中轴"等标签后刷新页面会直接进入该界面，无需重新选择
- **全局禁止下拉滑动**：通过CSS和JavaScript双重机制完全禁止页面下拉刷新和过度滚动，支持触摸、鼠标滚轮、键盘等多种输入方式的滚动边界控制
- **全屏弹窗设计**：所有模态框采用全屏设计（100vw×100vh），提供最大化的操作空间和沉浸式体验
- **隐藏滚动条**：添加跨浏览器兼容的CSS样式隐藏页面滚动条，提供更简洁的视觉体验
- **按钮对齐优化**：修复预设管理按钮与文章生成按钮的对齐问题，统一按钮样式和布局
- **按钮名称优化**：将"网格变换"按钮改为"网格变形"，更准确地描述拖拽变形功能
- **修复字符自动保存编码问题**：解决字符输入框显示URL编码字符（如%E9%9D%9E）而非实际汉字的问题
- **增强Cookie处理逻辑**：在`web/services/style.py`中添加URL解码机制，确保中文字符正确显示和保存
- **模态框布局统一化**：完成预设管理模态框布局重构，与文章生成模态框保持一致的设计风格和交互体验，优化按钮布局和预设列表显示

### 测试窗口显示修复 (2025-08)
- **修复测试窗口显示问题**：添加缺失的`anglesBox`容器元素，解决测试窗口无法显示调试信息的问题
- **完善测试窗口功能**：添加初始化函数和复制按钮，支持系统状态显示和内容复制
- **增强调试体验**：测试窗口现在能正常显示D2生成结果、网格变形状态、参数调试信息等

### 界面功能完善 (2025-08)
- **预设管理系统优化**：将预设下拉框改为弹窗模式，点击"📋 预设管理"按钮直接打开完整的预设管理界面
- **预设管理弹窗**：集成保存、加载、删除、导入导出等完整预设管理功能，支持搜索和批量操作
- **全面参数覆盖**：预设系统现在收集所有标签页参数，包括起笔、中间、笔锋、原始中轴、处理中轴等所有设置
- **网格变形集成**：预设系统完整支持网格变形参数保存和恢复，包括控制点位置和网格密度
- **智能状态恢复**：加载预设时自动恢复标签页状态、网格变形和所有参数设置，并自动刷新预览
- **鼠标跟随高亮效果**：ABCD1D2预览区域实现径向遮罩高亮效果，鼠标移动时显示25rem半径的彩色光圈
- **本地存储持久化**：使用localStorage保存预设，支持预设管理界面的增删改查操作

### 代码优化清理 (2025-08)
- **移除未使用的Warp.js库**：删除了CDN引用和相关无效代码，减少页面加载时间
- **清理无效函数调用**：移除了对不存在的`initWarpInstance()`函数的调用
- **代码简化**：网格变形功能完全依靠内部双线性插值算法，无外部依赖

### 拖拽变换功能重构完成 (2025-01)
- **独立组件封装**：创建`DragTransformComponent`类，提高代码复用性和可维护性
- **D1自动加载机制**：拖拽变换功能现在自动加载D1图片而非D0，确保变形基于处理后的版本
- **D2生成和保存功能**：通过专用按钮触发D2 SVG生成，自动保存到`output/compare/C_processed_centerline`文件夹
- **完整文件输出**：D2文件包含完整的变形后SVG内容，支持8000+字符的复杂路径数据
- **文件兼容性优化**：修复D2文件中的CSS样式问题，确保在各种SVG查看器中正常显示
- **命名规范统一**：D2文件现在使用与D1文件一致的时间戳命名格式：`{timestamp}_{char}_d2.svg`
- **完整API支持**：修复前端下载、后端生成、文件查找等所有涉及D2文件命名的接口
- **组件化架构**：封装所有拖拽变换相关功能，支持状态管理和错误处理
- **用户体验优化**：实现D2生成结果的右下角弹窗提示，成功显示绿色，失败显示红色，替代传统alert弹窗

### D2网格变形坐标变形修复完成 (2025-01)
- **修复前端变形函数**：解决deformPoint依赖backgroundImage导致变形失效的问题
- **统一坐标系映射**：前后端使用一致的SVG坐标系到网格坐标系转换逻辑
- **完整变形数据流**：前端网格状态 → 坐标变形 → 后端处理 → D2生成
- **智能变形检测**：只有存在实际控制点偏移时才生成D2
- **前端显示优化**：新增D2列显示，支持D1/D2对比查看
- **调试日志增强**：添加详细的变形过程日志便于问题诊断
- **D1文件查找优化**：修改`/find_d_files`接口，按文件名时间戳排序查找包含"d1"字符的最新SVG文件，确保网格变形基于最新生成的版本

### D1网格变形集成完成 (2025-01)
- **完整数据流建立**：前端网格变形参数自动传递到D1生成流程
- **智能变形检测**：只有控制点偏离标准位置时才应用变形处理
- **性能优化**：避免不必要的变形计算，保持生成效率
- **坐标系统一**：前后端坐标转换完全一致，确保变形精度状态正确显示
- **SVG自动加载和网格变形功能**：实现D0图片的自动加载到网格画布，支持拖拽控制点进行实时变形
- **D0/D1图像加载功能**：实现D0（原始基线）和D1（处理版本）图像的自动加载和显示，支持对比滑块
- **界面自动加载**：页面打开时自动恢复上次使用的标签页和字符，现有SVG文件自动检测加载
- **裁剪终点功能**：基于第三段弧长比例裁剪笔画终点，参数范围0.0-1.0，建议使用0.1-0.5
- **笔画倾斜优化**：每个笔画围绕自己的中心点独立倾斜，实现更自然的倾斜效果
- **原始中轴显示优化**：C列原始中轴现在以连续线条形式显示，更好地展现中轴线的连续性
- **D列颜色一致性修复**：D1始终使用D0的分段信息，确保D0与D1颜色完全一致

## 快速开始

### 环境要求
- Python 3.9+
- 依赖安装：`pip install -r requirements.txt`

### 启动Web界面（推荐）
```bash
# Windows
start_server_debug.bat

# 或手动启动
python start_server.py
# 访问 http://127.0.0.1:5000/
```

### IDE开发环境启动
在IDE中打开项目并启动开发服务器：
```bash
# 进入项目根目录
cd c:\Users\chenggong.zhang\OneDrive - ESTIA\Bureau\Generateur_Mot

# 启动Flask开发服务器
python start_server.py

# 或使用Flask命令
python -m flask --app web.app run --host=127.0.0.1 --port=5000 --debug
```

**IDE浏览器预览设置：**
- 服务器地址：`http://127.0.0.1:5000`
- 开发模式：启用debug模式支持热重载
- 端口配置：默认5000端口，可在`start_server.py`中修改

### 数据准备
```bash
# Windows PowerShell
powershell -ExecutionPolicy Bypass -File mmh_pipeline/scripts/get_mmh.ps1
python mmh_pipeline/scripts/merge_mmh.py

# macOS/Linux
bash mmh_pipeline/scripts/get_mmh.sh
python mmh_pipeline/scripts/merge_mmh.py
```

## 文档导航

### 📋 一级文档（本文档）
- 项目概览和快速开始
- 核心功能介绍
- 基本使用方法

### 📚 二级文档（详细技术文档）
- [**技术架构文档**](docs/ARCHITECTURE.md) - 系统架构、模块关系、处理流程
- [**Web界面文档**](docs/WEB_INTERFACE.md) - UI功能、参数说明、操作指南
- [**笔画处理文档**](docs/STROKE_PROCESSING.md) - 多阶段处理、算法实现、参数详解
- [**API接口文档**](docs/API_REFERENCE.md) - 接口规范、数据格式、调用示例
- [**开发指南**](docs/DEVELOPMENT.md) - 代码结构、测试方案、扩展开发

## 项目结构
```
Generateur_Mot/
├─ docs/                        # 📚 二级文档目录
├─ data/                        # 配置文件
├─ src/                         # 核心处理模块
│  └─ transforms/               # 模块化变换系统
├─ web/                         # Web界面和服务
├─ mmh_pipeline/               # 数据处理管道
├─ output/                      # 生成结果
└─ scripts/                     # 辅助脚本
```

## 基本使用

### 命令行模式
```bash
# 最简演示
python -m src.main --text 十 --seed 1

# 完整参数
python -m src.main \
  --text 你好世界 \
  --seed 42 \
  --style data/style_profiles.json \
  --stroke-map data/stroke_types.json \
  --merged-json mmh_pipeline/data/hanzi_data_full.json \
  --outdir output/samples
```

### Web界面模式（推荐）
1. 启动服务：双击 `start_server_debug.bat`，或：
```bash
python web/app.py
# 浏览器访问 http://127.0.0.1:8766/
```

2. 页面操作：
  - 输入单个字符，点击“生成对比”（会先清空 ABCD 四列，再生成，并将返回的 URL 立即填入页面）。
  - “刷新预览”：手动刷新 compare 预览页（默认不自动刷新，以避免旧链接干扰）。
  - “重置参数”：清空相关 Cookie 并恢复默认参数（不影响字符输入）。
  - 调参开关写入 cookie，并叠加到 `data/style_profiles.json` 形成临时覆盖；生成结果写入 `output/compare/`：
    - `A_outlines/`（轮廓）
    - `D2_median_fill/`（中轴填充）
    - `B_raw_centerline/`（原始中轴）
    - `D0_processed_centerline/`（处理中轴 D0）
    - `D1_further_processed_centerline/`（处理中轴 D1，在D0基础上进一步处理）
  - 路由别名：以下前缀等价（任选其一）：`/@compare/...`、`/compare/...`、根级（如 `/B_raw_centerline/<文件名.svg>`）
  - 说明：页面不提供“重启服务”按钮。

### 确定性（Determinism）
- 为保证“在不调整任何参数的情况下，同一字符每次生成完全一致”，系统采用“稳定随机种子”策略：
  - 基础种子来自 `data/style_profiles.json` 中的 `coherence.seed`（默认 131）
  - 实际使用种子 = `hash(coherence.seed, 字符编码)`，同一字符与配置在多次生成间保持一致
- 若希望不同字符也共享完全一致的随机序列，可将 `coherence.seed` 固定，同时避免改动 UI 参数（UI 参数变化会改变几何变换）。

### 测试
```bash
python -m unittest discover -s tests -p "test_*.py"
```

### 说明与兼容性
- 随机性：可在 `data/style_profiles.json` 设置 `coherence.seed`；运行时 `--seed` 可覆盖，以保证结果可复现。
- 笔画分类：默认几何特征自动分类；如需修正，可在 `data/stroke_types.json` 维护 `{ "字": ["heng","shu", ...] }`。
- 坐标系：MMH 的坐标翻转与归一化已在管线内部处理，无需额外关心。
- 兼容性：Python 3.9+；Windows/macOS/Linux（主要在 Windows 10 验证）。

### 处理中轴 D0 (基线处理中轴)
- 一个标准化的基线版本，它**不受**Web界面中`起笔`、`中间`、`笔锋`标签页下的参数影响。
- 此版本用于提供一个稳定、一致的对比基准。
- 其分段着色（蓝/灰/红）仅用于展示基于几何特征的默认分段结果。

### 处理中轴 D1 (用户风格化中轴)
- 在D0的基础上，应用了Web界面`起笔`、`中间`、`笔锋`标签页下所有用户自定义参数后生成的版本。
- 此版本反映了用户的实时风格调整，并遵循 `起笔` -> `笔锋` -> `中间` 的处理顺序。

### 处理中轴 D2 (网格变形中轴)
- 基于D1版本，应用网格变形效果后生成的最终版本。
- 支持用户通过拖拽变换界面进行交互式网格控制点变形。
- 自动裁剪到256×256固定尺寸，添加白色背景，确保输出一致性。

### 原始中轴（C 列）三色可视化（判定范围）
- 用“切割（Raw 窗口）”的两个比例参数划分：
  - 前 `raw_start_frac`（蓝）| 中间（灰）| 后 `raw_end_frac`（红）
  - 切分按弧长精确划分，必要时在段内做线性插值，保证比例准确
- 仅用于展示折点判定范围，不代表实际折点；实际分段请以 D 列为准。

### 生成 API 与前端填充
- `GET /gen?ch=字`：一次性生成 ABCD 四图，返回 JSON：`{ A, B, C, D, version }`。服务端会在生成前清空四列旧图，再写入新图，随后立即返回可用 URL。
- `GET /status?ch=字`：查询该字当下可用的最新文件名（用于回显或容错）。
- 前端拿到 `/gen` 的 JSON 后，直接把四个 URL 写入 `<img>` 的 `src`；同时追加 `?ts=时间戳` 防缓存。

### 常见问题（切割参数未生效）
- 必须勾选“切割”复选框，后端才会应用 `raw_start_frac/raw_end_frac`；仅改数值未勾选时不会生效。
- 参数修改后点击“生成对比”，前端会先把新值写入 cookie 再发起生成请求。
- **裁剪终点功能**：新增基于第三段（笔锋段）弧长比例的终点裁剪功能，只在最后一个折点之后的区域进行裁剪，保持折点位置不变，确保第三段颜色一致性。

### 近期更新（UI 与算法要点）
- **网格变形功能优化**：集成专业的Warp.js库替代手动SVG变形算法，提升变形质量和性能。使用距离权重算法实现局部变形，只有影响半径内的控制点才会对字符产生作用。支持对D0 SVG的直接变形操作。
- **文章SVG颜色优化**：文章生成功能现在将所有字符线条统一为纯黑色（#000000），消除三色分段显示，提升文字清晰度和打印效果。
- 原始中轴（C 列）渲染方式：改为连续线条显示，便于观察中轴线的连续性和流畅度。
- 处理中轴（D 列）分段机制：D0基线版本独立检测折点（35°–179°），D1用户版本始终使用D0的分段信息保持颜色完全一致。
- 折点搜索规则（D 列）：
  - 首折点：在 Raw 的前窗口内，取“第一个满足角度范围”的点；
  - 末折点：在 Raw 的后窗口内，取“最后一个满足角度范围”的点；
  - 若某个窗口内没有满足点，则该端不着色（对应整段为灰色）；两端都无则整条灰色；不再做全局回退。
- Raw 三色判定（C 列）：仍按 `raw_start_frac/raw_end_frac` 的弧长精确比例可视化“判定范围（蓝/灰/红）”，不代表实际折点。
- 短边全紫：勾选后，短笔画（弧长 < `isolate_min_len`）在 Raw 显示为紫色；D 列短笔画改为“单折点两段”（橙/绿）展示。
- 夹角范围控件移动到“处理中轴”面板；“切割”重命名为“三色分段”。
- 右侧新增"测试窗口"面板：用于显示D2生成结果和调试信息。
- **平滑强度功能**：新增独立的折点平滑阶段，在所有起笔功能完成后执行，可选择对第一个折点进行线性插值平滑，减少锐角感。
- **裁剪终点功能**：新增基于第三段（笔锋段）弧长比例的终点裁剪功能，只在最后一个折点之后的区域进行裁剪，保持折点位置不变，确保第三段颜色一致性。
- **笔画移动功能**：新增笔画整体垂直移动功能，支持正值向下、负值向上移动，确保笔画各段作为整体移动。
- **笔画倾斜优化**：使用统一倾斜角度确保方向一致性，每个笔画围绕自己的中心点旋转，保持整体倾斜效果的协调性。
- **端点保护机制移除**：完全取消端点保护机制，确保所有变换效果（移动、倾斜、缩放）能完整作用于整个笔画。
- **重采样功能移除**：简化处理流程，移除重采样阶段以提高处理效率。
- **界面简化**：
  - 移除"预览"标签按钮，简化标签切换栏
  - "处理中轴"标签页仅保留"夹角范围"功能，移除"固定分段边界"和"中轴变体×3"功能
  - 移除日志窗口，提供更简洁的用户体验
  - 所有参数控件添加详细的悬停提示说明
- **参数自动保存**：所有复选框状态和参数值自动保存到Cookie，页面刷新后自动恢复
- **处理流程优化**：笔画移动阶段在倾斜和缩放之前执行，确保移动效果不被其他变换覆盖
- **预览窗口优化**：删除缩放控制按钮，模态框扩大至95%视口空间，优化D图对比切换功能的尺寸约束，图像视觉居中且最大化填充预览区域
- **A图定位修复**：修正A图（轮廓）SVG变换矩阵的Y偏移计算，采用固定Y偏移值220，确保与其他图像完美对齐
- **B图对比功能**：中轴填充(B)图像点击放大时自动与D0图进行左右对比显示，便于观察中轴填充与处理中轴的差异

### 使用建议
- 想看到更多折点：
  - 适度放宽角度范围（如 65°–150°），或增大 Raw 窗口比例（如 0.35/0.35）。
  - 在“中间”面板开启重采样（96/128）、Chaikin=1、平滑窗口=3，以提升折点采样稳定性（仅在计算阶段提高密度）。
- 想强调钝角：将范围设为 90°–179°。

### 接口变化
- `/gen` 增加返回字段 `angles`：数组元素为
  - `{ stroke, is_short, first_idx, first_angle, last_idx, last_angle, short_split_idx, short_angle }`
  - 前端右栏自动渲染该表格，刷新于每次生成后。

### 笔画移动功能说明
- **执行时机**：笔画移动在倾斜和缩放之前执行，确保整个笔画作为完整单元移动。
- **工作原理**：对笔画的所有点进行垂直方向的统一偏移，保持笔画内部各段的相对位置关系。
- **参数控制**：
  - 正值：笔画向下移动
  - 负值：笔画向上移动
  - 0.0：无移动效果
- **技术实现**：在 `move_stage` 阶段处理，只有当用户勾选"笔画移动"复选框且偏移值不为0时才生效。
- **效果说明**：移动后的笔画保持原有的形状和内部结构，只是整体位置发生垂直偏移。
- **处理流程**：起笔角度 → 笔锋角度 → 裁剪起点/终点 → Chaikin平滑 → 移动平均平滑 → **笔画移动** → 倾斜 → 缩放

### 裁剪终点功能详细说明
- **执行时机**：在起笔角度和笔锋角度处理完成后，与裁剪起点同时执行。
- **工作原理**：基于第三段（笔锋段）的弧长比例进行裁剪，只影响最后一个折点之后的区域。
- **参数控制**：
  - 0.0：无裁剪效果
  - 0.2：裁剪第三段20%的长度
  - 1.0：完全裁剪第三段（裁剪到最后一个折点位置）
- **技术实现**：
  - 使用折点检测确定第三段边界
  - 从笔画终点向前累积弧长找到裁剪位置
  - 在目标线段内插值生成精确裁剪点
  - 跳过端点保护以保持裁剪效果
- **重要特性**：
  - 折点位置完全不变，确保笔画结构稳定
  - 第三段颜色保持一致，不会因裁剪改变分段着色
  - 只在第三段内操作，不影响起笔和中间段
- **使用建议**：建议裁剪比例控制在0.1-0.5之间，过大的裁剪可能影响字形识别度。

### 模块化变换系统架构
- **设计目标**：为未来支持偏旁级别的精细变换做准备，实现变换功能的模块化和可复用性。
- **核心组件**：
  - `BaseTransform`：所有变换的基础接口，定义统一的apply、validate_params等方法
  - `MoveTransform`：笔画移动变换，支持水平和垂直方向偏移
  - `TiltTransform`：笔画倾斜变换，支持围绕指定中心点旋转
  - `ScaleTransform`：笔画缩放变换，支持等比和非等比缩放
  - `SmoothTransform`：笔画平滑变换，支持Chaikin和移动平均两种算法
  - `TransformManager`：变换管理器，统一协调多个变换的执行
- **执行流程**：通过配置驱动的方式，按预定顺序应用各种变换，确保变换效果的一致性和可预测性。
- **扩展性**：模块化设计便于添加新的变换类型，为未来的偏旁识别和分级变换奠定基础。

### 测试方案（Test Plan）

#### 7.1 单元测试（Unit Test）
- **MMH 数据解析**：输入已知 JSON → 输出笔画数量、坐标是否匹配预期（提供“十”字内置用例）。
- **笔画分类**：用构造的几何用例（横/竖/撇/捺/点）验证分类输出；后续可替换为 10~20 个人工标注字，正确率≥95%。
- **风格参数采样**：
  - 固定随机种子 → 每次采样结果一致。
  - 多次随机采样 → 值域落在配置 `range` 或 `mean±`范围内（已实现截断）。
  - 风格插值 → 两套风格 t∈[0,1] 平滑过渡（已提供 `interpolate_styles`）。
- **骨架变换**：长度缩放、倾斜等几何断言（如横向距离按 `length_scale` 成比例变化）。
- **碰撞检测**：人为制造重叠笔画 → `collision_avoidance` 后两笔画最小距离增大。

运行：
```bash
python -m unittest discover -s tests -p "test_*.py"
```

#### 7.2 集成测试（Integration Test）
- **单字可视化对比**：选 50 个常用字，生成 SVG → 人眼检查结构未丢失、笔画无断裂、无异常重叠。
- **多字一致性**：同一段文字重复生成 5 次 → 检查整体风格保持一致，但笔画有微小差异（由分层随机带来）。
- **风格参数切换**：切换不同 `style_profiles.json` → 输出风格变化明显，且无渲染异常。

#### 7.3 性能测试（Performance Test）
- **目标**：
  - 50 字 ≤ 1 秒
  - 500 字 ≤ 8 秒
  - 内存占用：单次生成峰值 ≤ 500MB
- **方法**：脚本批量生成（循环调用 `src.main`），统计时间与内存（Windows 可用 `time` + 任务管理器观测，或后续加入 `psutil`）。

#### 7.4 主观可读性测试（Human Evaluation）
- **维度**：可读性（1~5）、自然度（1~5）、风格一致性（1~5）。
- **人群**：5~10 人小规模测试。
- **判定**：任一维度平均分 < 3 需调整风格参数或算法。

#### 7.5 回归测试（Regression Test）
- **基准集**：保留一组固定输入与输出 SVG（基准）。
- **流程**：每次改动后自动生成新 SVG，与基准进行结构差异对比（允许微小扰动，禁止结构性破坏）。
- **建议**：将 `--seed` 固定以最大化结果可重现性。

### 起笔/中间/笔锋（机制与参数）
- 每个笔画概念上分三段：
  - **段一（起笔）**: 起点 → 第一个折点
  - **段二（中间）**: 第一个折点 → 最后一个折点
  - **段三（笔锋）**: 最后一个折点 → 终点
- "起笔方向"仅对段一生效；"起笔长度比例"以段一的长度为基准。折点通过"转角阈值（`start_orientation.corner_thresh_deg`，默认 35°）"自动检测。
- **折点平滑**：在起笔角度和裁剪起点应用完成后，可选择对第一个折点进行平滑处理，减少锐角感，使线条更流畅。
- 为减少端点漂移，管线末尾有“保护终点K/保护起点K”。如仍观察到终点微动，可适度增大“保护终点K”，或减小平滑/重采样幅度。

### 界面（起笔+笔锋（C）面板）三列布局
- 三列：复选框 | 名称 | 参数框，左对齐，自动保存到 cookie，刷新后自动回显。
- 主要控件（合并原“起笔/笔锋/处理中轴角点范围”）：
  - 起笔角度（勾选后启用）+ 数值
  - 裁剪起点（勾选后启用）+ 数值
  - 笔锋角度（勾选后启用）+ 数值
  - 裁剪终点（勾选后启用）+ 数值
  - 夹角范围（勾选后启用）+ 最小/最大角度（用于折点判定区间）
  - 切割（Raw 窗口，勾选后启用）+ 蓝/红范围（0~0.9，用于 Raw 三色可视化）

### 处理中轴（D 列）分段着色
- 为直观展示段落：
  - 段一（起笔）为蓝色
  - 段二（中间）为深灰色
  - 段三（笔锋）为红色
- 折点阈值与“起笔”的阈值一致（`corner_thresh_deg`）。

### 原始中轴（C 列）三色可视化（判定范围）
- 用“切割（Raw 窗口）”的两个比例参数划分：
  - 前 `raw_start_frac`（蓝）| 中间（灰）| 后 `raw_end_frac`（红）
  - 切分按弧长精确划分，必要时在段内做线性插值，保证比例准确
- 仅用于展示折点判定范围，不代表实际折点；实际分段请以 D 列为准。

### 生成 API 与前端填充
- `GET /gen?ch=字`：一次性生成 ABCD 四图，返回 JSON：`{ A, B, C, D, version }`。服务端会在生成前清空四列旧图，再写入新图，随后立即返回可用 URL。
- `GET /status?ch=字`：查询该字当下可用的最新文件名（用于回显或容错）。
- 前端拿到 `/gen` 的 JSON 后，直接把四个 URL 写入 `<img>` 的 `src`；同时追加 `?ts=时间戳` 防缓存。

### 常见问题（切割参数未生效）
- 必须勾选“切割”复选框，后端才会应用 `raw_start_frac/raw_end_frac`；仅改数值未勾选时不会生效。
- 参数修改后点击“生成对比”，前端会先把新值写入 cookie 再发起生成请求。
- **裁剪终点功能**：新增基于第三段（笔锋段）弧长比例的终点裁剪功能，只在最后一个折点之后的区域进行裁剪，保持折点位置不变，确保第三段颜色一致性。

### 近期更新（UI 与算法要点）
- **网格变形功能优化**：集成专业的Warp.js库替代手动SVG变形算法，提升变形质量和性能。使用距离权重算法实现局部变形，只有影响半径内的控制点才会对字符产生作用。支持对D0 SVG的直接变形操作。
- **文章SVG颜色优化**：文章生成功能现在将所有字符线条统一为纯黑色（#000000），消除三色分段显示，提升文字清晰度和打印效果。
- 原始中轴（C 列）渲染方式：改为连续线条显示，便于观察中轴线的连续性和流畅度。
- 处理中轴（D 列）分段机制：D0基线版本独立检测折点（35°–179°），D1用户版本始终使用D0的分段信息保持颜色完全一致。
- 折点搜索规则（D 列）：
  - 首折点：在 Raw 的前窗口内，取“第一个满足角度范围”的点；
  - 末折点：在 Raw 的后窗口内，取“最后一个满足角度范围”的点；
  - 若某个窗口内没有满足点，则该端不着色（对应整段为灰色）；两端都无则整条灰色；不再做全局回退。
- Raw 三色判定（C 列）：仍按 `raw_start_frac/raw_end_frac` 的弧长精确比例可视化“判定范围（蓝/灰/红）”，不代表实际折点。
- 短边全紫：勾选后，短笔画（弧长 < `isolate_min_len`）在 Raw 显示为紫色；D 列短笔画改为“单折点两段”（橙/绿）展示。
- 夹角范围控件移动到“处理中轴”面板；“切割”重命名为“三色分段”。
- 右侧新增"测试窗口"面板：用于显示D2生成结果和调试信息。
- **平滑强度功能**：新增独立的折点平滑阶段，在所有起笔功能完成后执行，可选择对第一个折点进行线性插值平滑，减少锐角感。
- **裁剪终点功能**：新增基于第三段（笔锋段）弧长比例的终点裁剪功能，只在最后一个折点之后的区域进行裁剪，保持折点位置不变，确保第三段颜色一致性。
- **笔画移动功能**：新增笔画整体垂直移动功能，支持正值向下、负值向上移动，确保笔画各段作为整体移动。
- **笔画倾斜优化**：使用统一倾斜角度确保方向一致性，每个笔画围绕自己的中心点旋转，保持整体倾斜效果的协调性。
- **端点保护机制移除**：完全取消端点保护机制，确保所有变换效果（移动、倾斜、缩放）能完整作用于整个笔画。
- **重采样功能移除**：简化处理流程，移除重采样阶段以提高处理效率。
- **界面简化**：
  - 移除"预览"标签按钮，简化标签切换栏
  - "处理中轴"标签页仅保留"夹角范围"功能，移除"固定分段边界"和"中轴变体×3"功能
  - 移除日志窗口，提供更简洁的用户体验
  - 所有参数控件添加详细的悬停提示说明
- **参数自动保存**：所有复选框状态和参数值自动保存到Cookie，页面刷新后自动恢复
- **处理流程优化**：笔画移动阶段在倾斜和缩放之前执行，确保移动效果不被其他变换覆盖
- **预览窗口优化**：删除缩放控制按钮，模态框扩大至95%视口空间，优化D图对比切换功能的尺寸约束，图像视觉居中且最大化填充预览区域
- **A图定位修复**：修正A图（轮廓）SVG变换矩阵的Y偏移计算，采用固定Y偏移值220，确保与其他图像完美对齐
- **B图对比功能**：中轴填充(B)图像点击放大时自动与D0图进行左右对比显示，便于观察中轴填充与处理中轴的差异

### 使用建议
- 想看到更多折点：
  - 适度放宽角度范围（如 65°–150°），或增大 Raw 窗口比例（如 0.35/0.35）。
  - 在“中间”面板开启重采样（96/128）、Chaikin=1、平滑窗口=3，以提升折点采样稳定性（仅在计算阶段提高密度）。
- 想强调钝角：将范围设为 90°–179°。

### 接口变化
- `/gen` 增加返回字段 `angles`：数组元素为
  - `{ stroke, is_short, first_idx, first_angle, last_idx, last_angle, short_split_idx, short_angle }`
  - 前端右栏自动渲染该表格，刷新于每次生成后。

### 笔画移动功能说明
- **执行时机**：笔画移动在倾斜和缩放之前执行，确保整个笔画作为完整单元移动。
- **工作原理**：对笔画的所有点进行垂直方向的统一偏移，保持笔画内部各段的相对位置关系。
- **参数控制**：
  - 正值：笔画向下移动
  - 负值：笔画向上移动
  - 0.0：无移动效果
- **技术实现**：在 `move_stage` 阶段处理，只有当用户勾选"笔画移动"复选框且偏移值不为0时才生效。
- **效果说明**：移动后的笔画保持原有的形状和内部结构，只是整体位置发生垂直偏移。
- **处理流程**：起笔角度 → 笔锋角度 → 裁剪起点/终点 → Chaikin平滑 → 移动平均平滑 → **笔画移动** → 倾斜 → 缩放

### 裁剪终点功能详细说明
- **执行时机**：在起笔角度和笔锋角度处理完成后，与裁剪起点同时执行。
- **工作原理**：基于第三段（笔锋段）的弧长比例进行裁剪，只影响最后一个折点之后的区域。
- **参数控制**：
  - 0.0：无裁剪效果
  - 0.2：裁剪第三段20%的长度
  - 1.0：完全裁剪第三段（裁剪到最后一个折点位置）
- **技术实现**：
  - 使用折点检测确定第三段边界
  - 从笔画终点向前累积弧长找到裁剪位置
  - 在目标线段内插值生成精确裁剪点
  - 跳过端点保护以保持裁剪效果
- **重要特性**：
  - 折点位置完全不变，确保笔画结构稳定
  - 第三段颜色保持一致，不会因裁剪改变分段着色
  - 只在第三段内操作，不影响起笔和中间段
- **使用建议**：建议裁剪比例控制在0.1-0.5之间，过大的裁剪可能影响字形识别度。

### 模块化变换系统架构
- **设计目标**：为未来支持偏旁级别的精细变换做准备，实现变换功能的模块化和可复用性。
- **核心组件**：
  - `BaseTransform`：所有变换的基础接口，定义统一的apply、validate_params等方法
  - `MoveTransform`：笔画移动变换，支持水平和垂直方向偏移
  - `TiltTransform`：笔画倾斜变换，支持围绕指定中心点旋转
  - `ScaleTransform`：笔画缩放变换，支持等比和非等比缩放
  - `SmoothTransform`：笔画平滑变换，支持Chaikin和移动平均两种算法
  - `TransformManager`：变换管理器，统一协调多个变换的执行
- **执行流程**：通过配置驱动的方式，按预定顺序应用各种变换，确保变换效果的一致性和可预测性。
- **扩展性**：模块化设计便于添加新的变换类型，为未来的偏旁识别和分级变换奠定基础。
