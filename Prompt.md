# 🚀 Generateur_Mot 功能变更管理规范

> **重要说明**：每次执行功能变更命令时，AI 必须严格遵循本文档的规范和流程。

## 📖 目录

- [1. 快捷键触发系统](#1-快捷键触发系统)
- [2. 功能变更管理流程](#2-功能变更管理流程)
- [3. 应急模式处理](#3-应急模式处理)
- [4. 最佳实践与故障排除](#4-最佳实践与故障排除)

---

## 1. 快捷键触发系统

### 🎯 系统目的
定义输入首字符为数字时的触发规则，AI 必须识别数字并自动进入对应处理流程。

### 🔢 数字映射表

| 数字 | 流程类型 | 触发关键词 | 说明 |
|------|----------|------------|------|
| **1** | 新增功能 (Add) | 新增/增加/添加 | 在不破坏现有功能的前提下添加新特性 |
| **2** | 修改功能 (Modify) | 修改/更改/更新 | 在保持向后兼容的基础上修改现有功能 |
| **3** | 删除功能 (Remove) | 删除/移除/下线 | 安全下线功能，提供替代方案和迁移路径 |
| **4** | 应急模式 (Emergency) | 实现不了/报错/跑偏 | 功能实现受阻时的诊断和保守方案 |
| **5** | 重试优化 (Retry) | 继续尝试/不满足 | 在同一目标下尝试不同实现方案 |
| **9** | 系统诊断 (Debug) | 全面诊断/自检/分析 | 深度系统分析和架构依赖检查 |

### 📝 使用规范

**输入格式**：`数字 + 空格 + 功能描述`

**示例**：
```
1 新增文件上传大小限制功能
2 修改用户登录逻辑，支持手机号登录  
3 删除过时的统计接口
4 这个功能实现不了，报错太多
5 继续尝试改进文件上传限制功能
9 请检查系统依赖冲突问题
```

---

## 2. 功能变更管理流程

### 🎯 核心原则

1. **安全第一**：所有变更必须可回滚、可观测、可验证
2. **影响分析**：变更前必须进行功能影响面分析（FIA）
3. **渐进式发布**：使用特性开关和灰度发布
4. **文档同步**：代码变更与文档更新同步进行

### 🔄 标准流程

```
用户需求 → FIA分析 → 实施计划 → 代码实现 → 测试验证 → 部署发布 → 监控观测 → 文档更新
```

### 🚫 全局不变式

**适用于所有变更类型**：

- ✅ **接口兼容**：不破坏现有公共接口语义，必要时版本化（v1保留，v2新增）
- ✅ **架构规范**：控制器不直连DAO，鉴权在中间件，时间统一UTC
- ✅ **数据安全**：金额使用decimal（禁用float），日志必须脱敏
- ✅ **配置管理**：配置与密钥集中管理，严禁硬编码
- ✅ **合规要求**：遵守项目特定的不可触碰清单

### 🟩 新增功能流程 (Add)

**目标**：在不破坏现有功能的前提下添加新特性

**必须检查**：
- **接口兼容性**：新增接口而不替换现有接口
- **性能影响**：评估额外负载和资源消耗
- **安全漏洞**：新功能的安全风险评估
- **特性开关**：默认关闭状态，支持灰度发布

**输出要求**：
- 新增功能不影响现有业务逻辑
- 提供完整的回滚机制
- 包含性能基准测试
- 安全审计通过

### 🟨 修改功能流程 (Modify)

**目标**：在保持向后兼容的基础上修改现有功能

**必须检查**：
- **BREAKING检查**：确认是否改变现有接口语义
- **双轨策略**：v1保留，v2新增（如需要）
- **迁移路径**：如确为BREAKING变更，提供迁移指南
- **文档同步**：Runbook和测试用例同步更新

**输出要求**：
- 向后兼容或提供迁移路径
- 弃用声明和时间表（如适用）
- 完整的回归测试覆盖
- 用户通知和文档更新

### 🟥 删除功能流程 (Remove)

**目标**：安全下线功能，不造成用户业务中断

**必须检查**：
- **依赖扫描**：内部调用、外部调用、数据依赖
- **弃用周期**：合理的弃用通知期
- **替代方案**：提供功能替代或适配层
- **回滚准备**：快速恢复已删除功能的能力

**输出要求**：
- 完整的依赖影响分析
- 分阶段下线计划
- 数据迁移和清理方案
- 紧急恢复预案

### 📋 统一输出格式

**所有变更类型都必须按以下结构输出**：

```
## 功能摘要
[简要描述变更内容和目标]

## 澄清问题（≤3条）
1. [关键确认问题1]
2. [关键确认问题2]
3. [关键确认问题3]

## FIA（功能影响面分析）
1. **外部契约与兼容性**：[分析接口变更影响]
2. **数据与持久化**：[数据库和存储影响]
3. **性能与容量**：[性能基准和容量规划]
4. **安全与合规**：[安全风险和合规检查]
5. **时区/本地化/精度**：[国际化和精度要求]
6. **可靠性与可观测性**：[监控和日志要求]
7. **架构与代码组织**：[架构影响和代码结构]
8. **前端/UX**：[用户界面和体验影响]
9. **部署与运维**：[部署流程和运维影响]
10. **测试与回归**：[测试策略和覆盖范围]
11. **风险矩阵**：[风险评估和缓解措施]
12. **文档与变更日志**：[文档更新要求]

## 实施计划（≤6步）
1. [实施步骤1]
2. [实施步骤2]
...

## 补丁（统一diff格式）
[代码变更的具体实现]

## 测试（命令/断言/覆盖分支）
[测试用例和验证方法]

## 迁移与回滚
[数据迁移和回滚方案]

## 可观测性与报警
[监控指标和报警配置]

## 发布与回滚剧本
[部署步骤和回滚程序]

## 变更日志与文档
[文档更新和变更记录]
```

### ✅ 验收核对清单

**所有变更类型都必须通过以下检查**：

- [ ] 特性开关（默认off）+ 回滚方案
- [ ] 旧接口兼容或版本化处理
- [ ] DB Up/Down脚本（如有数据库变更）
- [ ] 幂等性/事务性/去重键明确
- [ ] 性能预算（P95/额外查询/限流）
- [ ] 安全项（鉴权/注入/脱敏/密钥管理）
- [ ] 时区UTC/金额decimal/编码统一
- [ ] 日志/指标/追踪 + 报警阈值
- [ ] 测试覆盖完整（成功/边界/异常/并发/断网/权限）
- [ ] 风险矩阵 + 回滚触发信号
- [ ] 发布剧本 + 一键回滚命令
- [ ] 文档与变更日志同步更新

---

## 3. 应急模式处理

### 🚨 触发条件

当出现以下情况时，立即进入应急模式：
- 功能实现无法达成目标
- 持续产生错误、回归或跑偏
- 多次尝试仍无法解决问题
- 出现系统性故障或冲突

### 🔍 应急处理流程

**⚠️ 重要**：应急模式下禁止直接输出大块代码，必须先完成诊断分析。

#### 1. 问题重述
- 用简洁语言重述用户的真实目标（≤2句话）
- 列出当前实现未达成目标的原因（≤3点）

#### 2. 根因分析
**技术层面**：
- 逻辑错误或算法缺陷
- 架构冲突或设计问题
- 约束条件未满足

**提示词层面**：
- 需求描述模糊不清
- 约束条件缺失
- 关键信息不足

**输出**：最可能的3个根因清单

#### 3. 保守可行方案
- 提供最小可行替代实现（确保能运行）
- 每个方案包含：优点/风险/适用条件
- 优先考虑简化但可靠的解决方案

#### 4. 澄清问题（≤3条）
向用户提出关键确认问题：
- 是否可以牺牲部分性能？
- 能否先简化功能需求？
- 是否接受临时替代方案？

#### 5. 重试策略
如需重新实现，推荐执行顺序：
1. **环境验证**：检查依赖和环境配置
2. **功能分解**：将复杂功能拆分为最小子任务
3. **逐步实现**：单个子任务实现并测试
4. **整合验证**：合并为完整功能并全面测试

### 🛡️ 保守方案示例

**数据库操作失败**：
- 降级为文件存储
- 使用内存缓存临时方案
- 简化数据结构

**性能问题**：
- 减少并发处理
- 增加缓存层
- 异步处理非关键操作

**集成问题**：
- 使用模拟数据
- 简化集成接口
- 分阶段集成

---

## 4. 最佳实践与故障排除

### 💡 最佳实践

#### 变更管理
1. **小步快跑**：将大功能拆分为小的增量变更
2. **特性开关**：所有新功能默认关闭，支持动态开启
3. **灰度发布**：从小范围用户开始，逐步扩大
4. **监控先行**：在变更前建立完善的监控体系

#### 代码质量
1. **单一职责**：每个变更只解决一个明确问题
2. **向后兼容**：优先考虑兼容性，避免破坏性变更
3. **测试驱动**：先写测试，再写实现
4. **文档同步**：代码变更与文档同步更新

#### 风险控制
1. **回滚准备**：每个变更都要有明确的回滚方案
2. **影响评估**：充分评估变更的影响范围
3. **分环境验证**：开发→测试→预发布→生产
4. **应急预案**：准备故障处理和恢复方案

### 🔧 常见问题与解决方案

#### Q: 如何处理BREAKING变更？
**A**: 
1. 评估是否真的需要BREAKING变更
2. 如必须，采用版本化策略（v1保留，v2新增）
3. 提供足够的弃用期和迁移指南
4. 与用户充分沟通变更计划

#### Q: 新功能影响现有性能怎么办？
**A**:
1. 使用特性开关，默认关闭新功能
2. 进行性能基准测试和对比
3. 考虑异步处理或缓存优化
4. 必要时进行架构调整

#### Q: 如何确保变更的安全性？
**A**:
1. 进行安全风险评估
2. 代码安全审计
3. 权限和访问控制检查
4. 敏感数据处理验证

#### Q: 删除功能时如何避免影响用户？
**A**:
1. 完整的依赖分析
2. 提前发布弃用通知
3. 提供替代方案或迁移路径
4. 分阶段下线，保留紧急恢复能力

### 📚 相关文档

- **架构文档**: `docs/ARCHITECTURE.md`
- **API文档**: `docs/API_REFERENCE.md`
- **部署指南**: `docs/DEPLOYMENT.md`
- **开发规范**: `docs/DEVELOPMENT.md`

### 🔄 文档维护

**维护责任**：开发团队负责人
**更新频率**：每月审查，重大变更时及时更新
**版本控制**：所有变更都要记录在变更日志中

---

> **最后提醒**：本文档是功能变更的核心指南，所有AI助手在处理功能变更请求时都必须严格遵循。如有疑问或需要澄清，请及时与用户确认。
