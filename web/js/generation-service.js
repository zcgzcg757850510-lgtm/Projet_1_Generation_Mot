/**
 * ÁîüÊàêÊúçÂä°Ê®°Âùó - Generation Service Module
 * Êèê‰æõD1/D2ÁîüÊàê„ÄÅÊñáÁ´†ÁîüÊàêÁ≠âÊ†∏ÂøÉÁîüÊàêÂäüËÉΩ
 */

/**
 * ÁîüÊàêÊúçÂä°Á±ª
 */
class GenerationService {
  constructor() {
    this.currentChar = '';
  }

  /**
   * Êõ¥Êñ∞ÂΩìÂâçÂ≠óÁ¨¶
   */
  updateCurrentChar() {
    const charInput = document.querySelector('input[name="char"]');
    this.currentChar = charInput ? charInput.value.trim() : '';
    return this.currentChar;
  }

  /**
   * ÁîüÊàêD2
   */
  async generateD2() {
    updateTestWindow('ÂºÄÂßãÁîüÊàêD2');
    
    // Êõ¥Êñ∞ÂΩìÂâçÂ≠óÁ¨¶
    this.updateCurrentChar();
    
    if (!this.currentChar) {
      updateTestWindow('‚ùå ËØ∑ÂÖàËæìÂÖ•Â≠óÁ¨¶');
      return;
    }

    updateTestWindow(`Ê≠£Âú®‰∏∫Â≠óÁ¨¶ "${this.currentChar}" ÁîüÊàêD2...`);

    try {
      // Âú®Ë∞ÉÁî®Ââç‰øùÂ≠òÁΩëÊ†ºÁä∂ÊÄÅÂà∞ÂêéÁ´ØÂèØËÆøÈóÆÁöÑ‰ΩçÁΩÆ
      if (typeof window.gridStateManager !== 'undefined' && window.gridStateManager.hasDeformation()) {
        const gridState = window.gridStateManager.getState();
        let canvasDimensions = { width: 800, height: 600 };
        
        if (typeof gridTransform !== 'undefined' && gridTransform.canvas) {
          canvasDimensions = {
            width: gridTransform.canvas.width,
            height: gridTransform.canvas.height
          };
        }
        
        // ‰øùÂ≠òÁΩëÊ†ºÁä∂ÊÄÅÂà∞ÂêéÁ´ØÂèØËÆøÈóÆÁöÑ‰∏¥Êó∂Â≠òÂÇ®
        const gridData = {
          gridState: gridState,
          canvasDimensions: canvasDimensions,
          character: this.currentChar
        };
        
        // ÂèëÈÄÅPOSTËØ∑Ê±ÇÔºåÂåÖÂê´ÁΩëÊ†ºÁä∂ÊÄÅ
        const response = await fetch('/gen', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            char: this.currentChar,
            type: 'D2',
            gridState: gridData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          const fillResult = {
            success: true,
            filename: result.filename,
            filepath: result.file_path || result.filepath
          };
          showD2Result(fillResult);
        } else {
          updateTestWindow(`‚ùå D2ÁîüÊàêÂ§±Ë¥•: ${result.error}`);
        }
      } else {
        // Ê≤°ÊúâÁΩëÊ†ºÂèòÂΩ¢Ôºå‰ΩøÁî®ÊôÆÈÄöGETËØ∑Ê±Ç
        const response = await fetch(`/gen?char=${encodeURIComponent(this.currentChar)}&type=D2`);
        const result = await response.json();
        
        if (result.success) {
          showD2Result(result);
        } else {
          updateTestWindow(`‚ùå D2ÁîüÊàêÂ§±Ë¥•: ${result.error}`);
        }
      }
    } catch (error) {
      console.error('D2ÁîüÊàêÈîôËØØ:', error);
      updateTestWindow(`‚ùå D2ÁîüÊàêÂ§±Ë¥•: ${error.message}`);
    }
  }

  /**
   * ÁîüÊàêÊñáÁ´†
   */
  async generateArticle() {
    const text = document.getElementById('articleText').value.trim();
    if (!text) {
      alert('ËØ∑ËæìÂÖ•Ë¶ÅÁîüÊàêÁöÑÊñáÁ´†ÂÜÖÂÆπ');
      return;
    }

    // Ëé∑ÂèñÂΩìÂâçÂ≠óÁ¨¶‰Ωú‰∏∫ÂèÇËÄÉÂ≠óÁ¨¶
    const charInput = document.querySelector('input[name="char"]');
    const currentChar = charInput ? charInput.value.trim() : '';

    // Show progress bar
    const progressBar = document.getElementById('articleProgress');
    const progressFill = progressBar.querySelector('.progress-fill');
    progressBar.classList.remove('hidden');
    progressFill.style.width = '0%';

    // Animate progress bar
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += Math.random() * 15;
      if (progress > 90) progress = 90;
      progressFill.style.width = progress + '%';
    }, 200);

    try {
      const params = {
        text: text,
        fontSize: document.getElementById('fontSize').value,
        lineSpacing: document.getElementById('lineSpacing').value,
        charSpacing: document.getElementById('charSpacing').value,
        backgroundType: document.querySelector('input[name="backgroundType"]:checked').value,
        referenceChar: currentChar
      };
      
      // Send request to backend
      const response = await fetch('/generate_article', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(params)
      });

      const result = await response.json();
      
      // Complete progress bar
      clearInterval(progressInterval);
      progressFill.style.width = '100%';
      
      if (result.success) {
        // Display preview
        const preview = document.getElementById('articlePreview');
        preview.innerHTML = `<img src="${result.svg_url}?t=${Date.now()}" alt="Generated Article" style="max-width: 100%; height: auto;">`;
        
        // Add download functionality
        const downloadBtn = document.getElementById('btnDownloadArticle');
        downloadBtn.onclick = function() {
          const link = document.createElement('a');
          link.href = result.svg_url;
          link.download = 'article_' + Date.now() + '.svg';
          link.click();
        };
      } else if (result.imageUrl) {
        // ÂÖºÂÆπÊóßÁöÑPNGÊ†ºÂºè
        preview.style.backgroundImage = 'none';
        preview.innerHTML = `<img src="${result.imageUrl}?t=${Date.now()}" alt="Generated Article" style="max-width: 100%; height: auto;">`;
        
        // Add download functionality for PNG
        const downloadBtn = document.getElementById('btnDownloadArticle');
        downloadBtn.onclick = function() {
          const link = document.createElement('a');
          link.href = result.imageUrl;
          link.download = 'article_' + Date.now() + '.png';
          link.click();
        };
      }
      
      // Hide progress bar after a delay
      setTimeout(() => {
        progressBar.classList.add('hidden');
      }, 1000);

    } catch (error) {
      clearInterval(progressInterval);
      progressBar.classList.add('hidden');
      console.error('Article generation error:', error);
      alert('ÊñáÁ´†ÁîüÊàêÂ§±Ë¥•: ' + error.message);
    }
  }

  /**
   * ‰ªéÁΩëÊ†ºÂèòÂΩ¢Â∑•ÂÖ∑ÁîüÊàêD2 (‰øùÊåÅÂêëÂêéÂÖºÂÆπ)
   */
  generateD2FromGrid() {
    // Á°Æ‰øù‰ΩøÁî®‰∏ªÁïåÈù¢ÊúÄÊñ∞Â≠óÁ¨¶
    const charInput = document.querySelector('input[name="char"]');
    const currentChar = charInput?.value?.trim();
    
    if (!currentChar) {
      updateTestWindow('‚ùå ËØ∑ÂÖàÂú®‰∏ªÁïåÈù¢ËæìÂÖ•Â≠óÁ¨¶');
      return;
    }
    
    this.currentChar = currentChar;
    updateTestWindow(`‰ΩøÁî®‰∏ªÁïåÈù¢Â≠óÁ¨¶: ${currentChar}`);
    
    this.generateD2();
  }

  /**
   * Êñ∞ÁöÑD2ÁîüÊàêÊåâÈíÆÂäüËÉΩ
   */
  generateNewD2() {
    console.log('üöÄ Êñ∞D2ÊåâÈíÆË¢´ÁÇπÂáª');
    
    // Ëé∑ÂèñÂΩìÂâçÂ≠óÁ¨¶
    const charInput = document.querySelector('input[name="char"]');
    const currentChar = charInput?.value?.trim();
    
    if (!currentChar) {
      updateTestWindow('‚ùå ËØ∑ÂÖàËæìÂÖ•Â≠óÁ¨¶');
      if (typeof showToast !== 'undefined') {
        showToast('ËØ∑ÂÖàËæìÂÖ•Â≠óÁ¨¶', 'warning');
      }
      return;
    }
    
    updateTestWindow(`üéØ Êñ∞D2ÁîüÊàê: ${currentChar}`);
    
    // ÂèØ‰ª•Âú®ËøôÈáåÂÆûÁé∞Êñ∞ÁöÑD2ÁîüÊàêÈÄªËæë
    // ÁõÆÂâçÂ§çÁî®Áé∞ÊúâÁöÑD2ÁîüÊàêÈÄªËæë
    this.currentChar = currentChar;
    this.generateD2();
  }

  /**
   * ÁîüÊàêD1 - ‰∏ªË¶ÅÁîüÊàêÂáΩÊï∞
   */
  async generateD1() {
    console.log('üöÄ D1ÊåâÈíÆË¢´ÁÇπÂáª');
    
    // Ëé∑ÂèñÂΩìÂâçÂ≠óÁ¨¶
    const charInput = document.querySelector('input[name="char"]');
    const currentChar = charInput ? charInput.value.trim() : '';
    
    if (!currentChar || currentChar.length !== 1) {
      alert('ËØ∑ËæìÂÖ•Âçï‰∏™Ê±âÂ≠ó');
      return;
    }
    
    console.log(`üéØ ÁõÆÊ†áÂ≠óÁ¨¶: ${currentChar}`);
    
    try {
      // ‰øùÂ≠òË°®ÂçïÂèÇÊï∞
      const form = document.querySelector('form');
      if (form) {
        form.querySelectorAll('input').forEach((el) => {
          if (!el.name) return;
          let val = '';
          if (el.type === 'checkbox') { 
            val = el.checked ? '1' : '0'; 
          } else { 
            val = el.value || ''; 
          }
          if (typeof setPref !== 'undefined') {
            setPref(el.name, val);
          }
        });
      }
      
      // Ê£ÄÊü•ÁΩëÊ†ºÂèòÂΩ¢Áä∂ÊÄÅ
      let gridState = null;
      if (typeof window.gridStateManager !== 'undefined' && window.gridStateManager.hasDeformation()) {
        gridState = window.gridStateManager.getState();
        console.log('üîÑ Ê£ÄÊµãÂà∞ÁΩëÊ†ºÂèòÂΩ¢Áä∂ÊÄÅ');
        if (gridState && (!gridState.canvas_dimensions || !gridState.canvas_dimensions.width)) {
          try {
            const dims = {
              width: (window.gridTransform && window.gridTransform.canvas && window.gridTransform.canvas.width) ? window.gridTransform.canvas.width : 800,
              height: (window.gridTransform && window.gridTransform.canvas && window.gridTransform.canvas.height) ? window.gridTransform.canvas.height : 600
            };
            gridState.canvas_dimensions = dims;
          } catch (e) {
            console.warn('‚ö†Ô∏è ËÆ°ÁÆóÁîªÂ∏ÉÂ∞∫ÂØ∏Â§±Ë¥•:', e);
          }
        }
      }
      
      const requestBody = { char: currentChar, type: 'D1' };
      if (gridState) {
        requestBody.grid_state = gridState;
      }
      
      // ÂèëÈÄÅËØ∑Ê±Ç
      const response = await fetch('/api/gen_single', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody),
        cache: 'no-store'
      });
      
      if (!response.ok) {
        const txt = await response.text();
        console.error('ÁîüÊàêÂ§±Ë¥•', txt);
        console.error('ÁîüÊàêÂ§±Ë¥•Ôºö' + txt);
        return;
      }
      
      const data = await response.json();
      console.log('üì• ÊúçÂä°Âô®ÂìçÂ∫î:', data);
      
      // Êõ¥Êñ∞È¢ÑËßàÂç°Áâá
      if (window.previewCardManager) {
        const withTs = (u) => u ? (u + (u.includes('?') ? '&' : '?') + 'ts=' + Date.now()) : u;
        if (data.url) {
          window.previewCardManager.updateCard('D1', withTs(data.url));
        }
        if (data.base_url) {
          console.log('üìÅ D1Âü∫Á°ÄÁâàÊú¨:', data.base_url);
        }
      }
      
      console.log('‚úÖ D1ÁîüÊàêÂÆåÊàê');
      
      // Á°Æ‰øùÊâÄÊúâÁé∞ÊúâSVGÊñá‰ª∂ÈÉΩÂ∑≤Âä†ËΩΩÂà∞È¢ÑËßàÁ™óÂè£
      if (window.previewManager) {
        setTimeout(() => {
          window.previewManager.loadExistingSVGs();
        }, 500);
      }
      
      // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
      if (typeof showToast !== 'undefined') {
        showToast('ÁîüÊàêÂÆåÊàê', 'success');
      }
      
    } catch (error) {
      console.error('D1ÁîüÊàêÈîôËØØ:', error);
      console.error('ÁîüÊàêÂá∫ÈîôÔºö' + error.message);
    }
  }

  /**
   * Á∫ØË∞ÉÁî®D2ÊåâÈíÆ - Âè™ÊúâË∞ÉÁî®Êé•Âè£ÂíåÊòæÁ§∫ÁªìÊûú‰∏§‰∏™ÂäüËÉΩ
   */
  async generateD2WithNewInterface() {
    updateTestWindow('üöÄ D2ÊåâÈíÆË¢´ÁÇπÂáªÔºåÂºÄÂßãÊâßË°å...');
    console.log('üöÄ D2ÊåâÈíÆË¢´ÁÇπÂáª');
    
    // Ëé∑ÂèñÂΩìÂâçÂ≠óÁ¨¶
    const charInput = document.querySelector('input[name="char"]');
    const currentChar = charInput ? charInput.value.trim() : '';
    
    if (!currentChar) {
      updateTestWindow('‚ùå ËØ∑ÂÖàËæìÂÖ•Â≠óÁ¨¶');
      return;
    }
    
    updateTestWindow(`üéØ ÁõÆÊ†áÂ≠óÁ¨¶: ${currentChar}`);
    
    try {
      // Ê£ÄÊü•ÊòØÂê¶ÊúâÁΩëÊ†ºÂèòÂΩ¢
      let hasGridDeformation = false;
      let gridStateData = null;
      
      if (typeof window.gridStateManager !== 'undefined') {
        hasGridDeformation = window.gridStateManager.hasDeformation();
        if (hasGridDeformation) {
          gridStateData = window.gridStateManager.getState();
          updateTestWindow('üîÑ Ê£ÄÊµãÂà∞ÁΩëÊ†ºÂèòÂΩ¢ÔºåÂ∞ÜÂ∫îÁî®Âà∞D2ÁîüÊàê');
        }
      }
      
      let response;
      
      if (hasGridDeformation && gridStateData) {
        // ÊúâÁΩëÊ†ºÂèòÂΩ¢Ôºå‰ΩøÁî®POSTËØ∑Ê±Ç
        updateTestWindow('üì§ ÂèëÈÄÅPOSTËØ∑Ê±ÇÔºàÂåÖÂê´ÁΩëÊ†ºÂèòÂΩ¢Êï∞ÊçÆÔºâ...');
        
        response = await fetch('/gen', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            char: currentChar,
            type: 'D2',
            gridState: gridStateData
          })
        });
      } else {
        // Êó†ÁΩëÊ†ºÂèòÂΩ¢Ôºå‰ΩøÁî®GETËØ∑Ê±Ç
        updateTestWindow('üì§ ÂèëÈÄÅGETËØ∑Ê±Ç...');
        
        response = await fetch(`/gen?char=${encodeURIComponent(currentChar)}&type=D2`);
      }
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      updateTestWindow(`üì• ÊúçÂä°Âô®ÂìçÂ∫î: ${JSON.stringify(result, null, 2)}`);
      
      if (result.success) {
        updateTestWindow('‚úÖ D2ÁîüÊàêÊàêÂäüÔºÅ');
        
        // ÊòæÁ§∫ÁªìÊûú
        showD2Result({
          success: true,
          filename: result.filename,
          filepath: result.file_path || result.filepath || result.file
        });
        
      } else {
        updateTestWindow(`‚ùå D2ÁîüÊàêÂ§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}`);
      }
      
    } catch (error) {
      console.error('D2ÁîüÊàêÈîôËØØ:', error);
      updateTestWindow(`‚ùå D2ÁîüÊàêÂºÇÂ∏∏: ${error.message}`);
    }
  }
}

/**
 * ÊòæÁ§∫D2ÁîüÊàêÁªìÊûú
 */
function showD2Result(result) {
  if (!result.success) {
    updateTestWindow('‚ùå D2ÁîüÊàêÂ§±Ë¥•');
    return;
  }

  const filename = result.filename;
  const filepath = result.filepath;
  
  updateTestWindow(`‚úÖ D2ÁîüÊàêÂÆåÊàê: ${filename}`);
  updateTestWindow(`üìÅ Êñá‰ª∂Ë∑ØÂæÑ: ${filepath}`);
  
  // Ëá™Âä®Âä†ËΩΩÂà∞‰∏ªÁïåÈù¢ÁöÑimgD2ÂÖÉÁ¥†
  const imgD2 = document.getElementById('imgD2');
  if (imgD2 && filepath) {
    const url = filepath.startsWith('/') ? filepath : '/' + filepath;
    const timestampedUrl = url + '?t=' + Date.now();
    
    updateTestWindow(`üîÑ Ê≠£Âú®Âä†ËΩΩD2Âà∞‰∏ªÁïåÈù¢: ${timestampedUrl}`);
    
    imgD2.onerror = function() {
      updateTestWindow(`‚ùå D2Êñá‰ª∂Âä†ËΩΩÂ§±Ë¥•: ${filename || 'unknown'}`);
      updateTestWindow(`Â§±Ë¥•ÁöÑURL: ${url}`);
      imgD2.style.opacity = '0.5'; 
    }; 
    
    imgD2.onload = () => {      
      imgD2.style.opacity = '1'; 
      console.log('‚úÖ D2Êñá‰ª∂Â∑≤ÊàêÂäüÂä†ËΩΩÂà∞‰∏ªÁïåÈù¢');
      updateTestWindow(`‚úÖ D2Êñá‰ª∂Â∑≤ÊàêÂäüÂä†ËΩΩÂà∞‰∏ªÁïåÈù¢: ${filename || 'D2Êñá‰ª∂'}`);
    }; 
    
    imgD2.src = timestampedUrl; 
    imgD2.style.display = 'block';
  }
  
  // ÂêåÊó∂Â∞ùËØïÂä†ËΩΩÂà∞ÁΩëÊ†ºÂèòÂΩ¢ÁöÑD2Á™óÂè£
  const gridD2Element = document.querySelector('#dragTransformModal .d2-preview img');
  if (gridD2Element && filepath) {
    const url = filepath.startsWith('/') ? filepath : '/' + filepath;
    const timestampedUrl = url + '?t=' + Date.now();
    
    const setImg = (el, url, filename) => {
      el.onerror = function() {
        updateTestWindow(`‚ùå D2Êñá‰ª∂Âä†ËΩΩÂ§±Ë¥•: ${filename || 'unknown'}`);
        updateTestWindow(`Â§±Ë¥•ÁöÑURL: ${url}`);
        el.style.opacity = '0.5'; 
      }; 
      
      el.onload = () => {      
        el.style.opacity = '1'; 
        console.log('‚úÖ D2Êñá‰ª∂Â∑≤ÊàêÂäüÂä†ËΩΩÂà∞ÁΩëÊ†ºÂèòÂΩ¢(D2)Á™óÂè£');
        updateTestWindow(`‚úÖ D2Êñá‰ª∂Â∑≤Ëá™Âä®Â°´ÂÖÖÂà∞ÁΩëÊ†ºÂèòÂΩ¢(D2)Á™óÂè£: ${filename || 'D2Êñá‰ª∂'}`);
      }; 
      
      el.src = url; 
      el.style.display = 'block';
    };
    
    // ‰ΩøÁî®setImgÂáΩÊï∞Âä†ËΩΩD2ÂõæÁâá
    updateTestWindow(`Ê≠£Âú®Âä†ËΩΩD2Êñá‰ª∂: ${filename || 'D2Êñá‰ª∂'}`);
    setImg(gridD2Element, timestampedUrl, filename);
  }
}

// Âª∂ËøüÂàùÂßãÂåñÁîüÊàêÊúçÂä°
let generationService = null;

// ÂàùÂßãÂåñÂáΩÊï∞
function initGenerationService() {
    if (!generationService) {
        // Á°Æ‰øùÁä∂ÊÄÅÁÆ°ÁêÜÂô®Â∑≤ÂàùÂßãÂåñ
        if (typeof window.initStateManager === 'function') {
            window.initStateManager();
        }
        
        generationService = new GenerationService();
        
        // Êõ¥Êñ∞ÂÖ®Â±ÄÂØºÂá∫
        window.GenerationService = {
            generateD1: () => generationService.generateD1(),
            generateD2: () => generationService.generateD2(),
            generateD2FromGrid: () => generationService.generateD2FromGrid(),
            generateNewD2: () => generationService.generateNewD2(),
            generateD2WithNewInterface: () => generationService.generateD2WithNewInterface(),
            generateArticle: () => generationService.generateArticle(),
            showD2Result: showD2Result
        };
        
        // ‰øùÊåÅÂêëÂêéÂÖºÂÆπÁöÑÂÖ®Â±ÄÂáΩÊï∞
        window.genOnce = () => generationService.generateD1();
        window.generateD2FromGrid = () => generationService.generateD2FromGrid();
        window.generateNewD2 = () => generationService.generateNewD2();
        window.generateD2WithNewInterface = () => generationService.generateD2WithNewInterface();
        window.generateArticle = () => generationService.generateArticle();
        window.showD2Result = showD2Result;
        
        console.log('‚úÖ ÁîüÊàêÊúçÂä°Ê®°ÂùóÂ∑≤ÂàùÂßãÂåñ');
    }
    return generationService;
}

// DOMÂä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÂàùÂßãÂåñ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGenerationService);
} else {
    initGenerationService();
}

// ÂØºÂá∫ÂàùÂßãÂåñÂáΩÊï∞
window.initGenerationService = initGenerationService;

console.log('‚úÖ ÁîüÊàêÊúçÂä°Ê®°ÂùóÂ∑≤Âä†ËΩΩ');
